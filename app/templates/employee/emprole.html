{% extends "base.html" %}

{% load static %}
{% load filters %}

{% block header2 %}
<div class="main-content">

    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Employee Role </h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboard</a></li>
                                <li class="breadcrumb-item active">Employee Role Management</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- end page title 

                    <div class="alert alert-danger" role="alert">
                        This is <strong>Datatable</strong> page in wihch we have used <b>jQuery</b> with cnd link!
                    </div>  -->

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">

                            <div class="row">
                                <div class="col-xl-6 col-lg-6 col-md-6 col-12">
                                    <h2>Employee Role </h2>
                                </div>
                                <div class="col-xl-4 col-lg-4 col-md-4 col-12"></div>
                                <div class="col-xl-2 col-lg-2 col-md-2 col-12">
                                    <button type="button" class="btn btn-info" style="float:right;"
                                        data-bs-toggle="modal" data-bs-target=".bs-example-modal-lg">+ Add
                                        </button>
                                    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog"
                                        aria-labelledby="myLargeModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <form id="createForm" enctype="multipart/form-data">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="myLargeModalLabel">Employee Role
                                                        </h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close" onclick="clearErrors()">
                                                        </button>
                                                    </div>
                                                    <hr>
                                                    <div class="modal-body">

                                                        {% csrf_token %}
                                                        <div class="row">
                                                            <div class="row mb-2">
                                                                <label for="id_name" class="form-label">Role
                                                                    Name:</label>
                                                                <input type="text" name="name" class="form-control"
                                                                    id="name" value="">
                                                                <span id="nameError" class="error-message"></span>


                                                            </div>
                                                            <div class="mt-2 mb-3">
                                                                <label for="id_description"
                                                                    class="form-label">Description:</label>
                                                                    <textarea name="description" class="form-control" id="description" value="" rows ="5"></textarea>
                                                                <!-- <input type="text" name="description"
                                                                    class="form-control" id="description" value=""> -->
                                                                <span id="descriptionError"
                                                                    class="error-message"></span>

                                                            </div>


                                                        </div>
                                                    </div>
                                                    <hr>
                                                    <div class="modal-footer">
                                                        <button class="btn btn-link link-success fw-medium shadow-none"
                                                            data-bs-dismiss="modal"><i
                                                                class="ri-close-line me-1 align-middle"
                                                                onclick="clearErrors()"></i> Close</button>
                                                        <button type="button" class="btn btn-primary "
                                                            onclick="createFunction(this)">Save </button>
                                                    </div>
                                                </form>
                                            </div>
                                            <!-- /.modal-content -->
                                        </div>
                                        <!-- /.modal-dialog -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">

                            <div class="row">
                                {% include "search.html" %}
                            </div>

                            <table id="example"
                                class="table table-bordered dt-responsive nowrap table-striped align-middle"
                                style="width:100%">
                                <thead>
                                    <tr>
                                        <!-- <th scope="col" style="width: 10px;">
                                            <div class="form-check">
                                                <input class="form-check-input fs-15" type="checkbox" id="checkAll"
                                                    value="option">
                                            </div>
                                        </th> -->
                                        <th data-ordering="false">SR No.</th>
                                        <th data-ordering="false">Role Name</th>
                                        <th data-ordering="false">Description</th>

                                        <th data-ordering="false">Action</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    {% for i in queryset %}
                                    <tr>
                                        <!-- <th scope="row">
                                            <div class="form-check">
                                                <input class="form-check-input fs-15" type="checkbox" name="checkAll"
                                                    value="{{ category.id }}">
                                            </div>
                                        </th> -->
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ i.name }}</td>
                                        <td>{{ i.description | truncate_description }}</td>

                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-soft-secondary btn-sm me-2" type="button" data-id="{{i.id}}" onclick="openModal('viewModal', '{{ i.id }}')">
                                                    <!-- <i class="ri-eye-fill align-bottom me-2 text-muted"></i> -->
                                                    View
                                                </button>
                                                <button class="btn btn-soft-primary btn-sm me-2" type="button" onclick="openModal('editModal','{{ i.id }}')">
                                                    <!-- <i class="ri-pencil-fill align-bottom me-2 text-muted"></i>  -->
                                                    Edit
                                                </button>
                                                <button class="btn btn-soft-danger btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#deleteModal{{ i.id }}">
                                                    <!-- <i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i>  -->
                                                    Delete
                                                </button>
                                            </div>

                                            <!-- view modal -->


                                           


                                            <div class="modal fade" id="viewModal_{{i.id}}" tabindex="-1" role="dialog" aria-labelledby="viewModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">

                                                <div class="modal-dialog modal-lg">
                                            
                                                    <div class="modal-content">
                                            
                                                        <div class="modal-header">
                                            
                                                            <h5 class="modal-title" id="viewModalLabel">{{i.name}}</h5>
                                            
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="CloseModel('viewModal', '{{i.id}}')"></button>
                                            
                                                        </div>
                                            
                                                        <div class="modal-body">
                                                          <div class="row">
                                                              
                                            
                                                            <div class="row mb-2">
                                                                <label for="{{i.id}}_name" class="form-label">Role Name:</label>
                                                                <input type="text" class="form-control" id="{{i.id}}_name" name="name" value="{{i.name}}" readonly>
                                                            </div>

                                                            <div class="mt-2 mb-3">
                                                              <label for="{{i.id}}_description" class="form-label">Description:</label>
                                                              <!-- <input typ
                                                              e="text" class="form-control" id="{{i.id}}_description" name="description" value="{{i.description}}" readonly> -->
                                                              <textarea class="form-control" id="{{i.id}}_description" name="description" rows="5" value="{{i.description}}" readonly >{{i.description}}</textarea>
                                                            </div>

                                                        </div>

                                                      </div>
                                            
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="CloseModel('viewModal', '{{i.id}}')">Close</button>
                                                        </div>
                                            
                                                    </div>
                                            
                                                </div>
                                            
                                            </div>


                                            <!-- edit modal -->

                                            <div class="modal fade bs-example-modal-lg"  tabindex="-1"

                                                data-bs-keyboard="false" id="editModal_{{i.id}}"    data-bs-backdrop="static"   

                                                role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                                                <div class="modal-dialog modal-lg">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="myLargeModalLabel">{{i.name}}
                                                                </h5>
                                                            <button type="button" class="btn-close"
                                                                data-bs-dismiss="modal" aria-label="Close"
                                                                onclick="CloseModel('editModal','{{i.id}}')">
                                                            </button>
                                                        </div>
                                                        <hr>
                                                        <div class="modal-body">
                                                            

                                                            <form id="editForm{{ i.id }}" enctype="multipart/form-data">
                                                                {% csrf_token %}
                                                            <div class="row mb-2"> 
                                                                <div class="row mb-2">
                                                                    <label for="editCategoryName">Role Name:</label>
                                                                    <input type="text" class="form-control" name="name"
                                                                        id="{{i.id}}_name" value="{{ i.name }}">

                                                                    <span id="{{i.id}}_nameError"
                                                                        class="error-message"></span>
                                                                </div>
                                                                <div class="mt-2 mb-3">
                                                                    <label
                                                                        for="editCategoryDescription">Description:</label>
                                                                        <textarea type="text" class="form-control"
                                                                        id="{{i.id}}_description" name="description" rows="5"
                                                                        value="{{ i.description }}"> {{ i.description }} </textarea>
                                
                                
                                                                    <span id="{{i.id}}_descriptionError"
                                                                        class="error-message"></span>
                                                                </div>
                                                            </div>
                                                            <div class="text-center">
                                                                <button type="button" class="btn btn-secondary"
                                                                    data-bs-dismiss="modal"
                                                                    onclick="CloseModel('editModal','{{i.id}}')">Close</button>
                                                                <button type="button" class="btn btn-primary"
                                                                    onclick="updateFunction(this,'{{i.id}}')">Save
                                                                    changes</button>
                                                            </div>  

                                                            </form>
                                                        

                                                        </div>
                                                        

                                                    </div>
                                                    <!-- /.modal-content -->
                                                </div>
                                                <!-- /.modal-dialog -->
                                            </div>


                                            <!-- for delete -->

                                            <div class="modal fade" id="deleteModal{{ i.id}}" tabindex="-1"
                                                aria-labelledby="deleteModalLabel-{{ forloop.counter }}"
                                                aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title"
                                                                id="deleteModalLabel-{{ forloop.counter }}"> Delete
                                                                Employee Role '{{i.name}}'</h5>
                                                            <button type="button" class="btn-close"
                                                                data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <p> Are you sure you want to delete "{{ i.name }}"? </p>
                                                        </div>
                                                        <div class="modal-footer">
                                                             <button type="button" class="btn btn-secondary"
                                                                        data-bs-dismiss="modal"
                                                                        onclick="CloseModel('editModal','{{i.id}}')">Close</button>
                                                            <button type="button"
                                                                onclick="deleteFunction(this,'{{i.id}}')"
                                                                class="btn btn-danger">Delete</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <div class="row">
                                {% include 'pagination.html' %}
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <!-- container-fluid -->
        </div>
        <!-- End Page-content -->

    </div>
    <!-- end main content-->

</div>
<!-- END layout-wrapper -->
<!--start back-to-top-->
<button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
    <i class="ri-arrow-up-line"></i>
</button>
<!--end back-to-top-->

<!--preloader-->
<div id="preloader">
    <div id="status">
        <div class="spinner-border text-primary avatar-sm" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>


<script>


    document.addEventListener('DOMContentLoaded', function () {


        const viewButtons = document.querySelectorAll('.view-btn');
        const editButtons = document.querySelectorAll('.edit-btn');
        const delButtons = document.querySelectorAll('.del-btn');

        viewButtons.forEach(button => {
            button.addEventListener('click', function () {
                const modalId = this.getAttribute('data-target');
                const modal = document.querySelector(modalId);
                if (modal) {
                    $(modal).modal('show');
                }
            });
        });


        editButtons.forEach(button => {
            button.addEventListener('click', function () {
                const modalId = this.getAttribute('data-target');
                const modal = document.querySelector(modalId);
                if (modal) {
                    $(modal).modal('show');
                }
            });
        });

        delButtons.forEach(button => {
            button.addEventListener('click', function () {
                const modalId = this.getAttribute('data-target');
                const modal = document.querySelector(modalId);
                if (modal) {
                    $(modal).modal('show');
                }
            });
        });


    });


    // create form

    function createFunction(button) {
        var formId = `createForm`;   //change
        var formElement = document.getElementById(formId);
        try {
            disableButton(button);
            var isValid = true;
            var errors = {};
            var formData = new FormData();

            var requiredKeys = ['name','description'];   //change


            formData.append('name', getValueOrDefault(formElement.querySelector('input[name="name"]').value));              //change
            formData.append('description', getValueOrDefault(formElement.querySelector('input[name="description"]').value));


            requiredKeys.forEach(function (key) {
                var value = formData.get(key);
                if (!value.trim()) {
                    isValid = false;
                    errors[key] = ['This field may not be blank.'];
                }
            });

            if (!isValid) {
                enableButton(button);
                console.log(errors);
                handleCreateErrors(errors);
                return;
            } else {
                $(`#${formId} input, #${formId} button`).prop('disabled', true);

            }

            $.ajax({
                url: '/add_emproles/',                //change
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                data: formData,
                processData: false,
                contentType: false,
                success: function (response, status, xhr) {
                    console.error(status);
                    if (xhr.status === 201) {
                        showToast(successMesssage?.message, '', successMesssage?.bgColor, true);
                    } else {
                        console.error(error);
                        restoreForm(formId, button)

                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr, status, error);
                    if (xhr.status === 400) {
                        if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
                            handleCreateErrors(transformErrors(xhr.responseJSON));
                            restoreForm(formId, button)

                        } else {
                            showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                            restoreForm(formId, button)

                        }
                    }
                    else if (xhr.status === 401 || 404) {
                        showToast(xhr?.responseJSON?.details, '', errorAlertMessage?.bgColor);
                        restoreForm(formId, button)

                    }
                    else {
                        showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                        restoreForm(formId, button)

                    }
                }
            });
        } catch (error) {
            showToast(errorOccured?.message, '', errorOccured?.bgColor);
            restoreForm(formId, button)
            console.error(error);
        }
    }


    // update

    function updateFunction(button, saveId) {

        var formId = `editForm${saveId}`;   //change
        var formElement = document.getElementById(formId);

        var isValid = true;
        var errors = {};


        try {
            disableButton(button);
            clearErrors();

            const formData = new FormData();
 
            formData.append('name', getValueOrDefault(formElement.querySelector('input[name="name"]').value));    //change
            formData.append('description', getValueOrDefault(formElement.querySelector('input[name="description"]').value));


            var requiredKeys = ['name'];     //change

            requiredKeys.forEach(function (key) {
                var value = formData.get(key);
                if (!value.trim()) {
                    isValid = false;
                    errors[key] = ['This field may not be blank.'];
                }
            });

            if (!isValid) {
                enableButton(button);
                console.log(errors);
                handleUpdateErrors(saveId, transformErrors(errors));
                return;
            } else {
                $(`#${formId} input, #${formId} button`).prop('disabled', true);

            }


            console.log(csrftoken);
            $.ajax({
                url: '/update_emproles/' + saveId + '/',   //change
                type: 'PUT',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                processData: false,
                contentType: false,
                data: formData,
                success: function (response, status, xhr) {
                    if (xhr.status === 200) {
                        showToast(updateMessage?.message, '', updateMessage?.bgColor, true);
                        restoreForm(formId, button)
                    } else {
                        showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                        restoreForm(formId, button)

                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr, status, error);
                    if (xhr.status === 400) {
                        if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
                            handleUpdateErrors(saveId, transformErrors(xhr.responseJSON));
                            restoreForm(formId, button)
                        } else {

                            showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                            restoreForm(formId, button)

                        }
                    }
                    else if (xhr.status === 401 || 404) {
                        showToast(xhr?.responseJSON?.details, '', errorAlertMessage?.bgColor);
                        restoreForm(formId, button)

                    }
                    else {

                        showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                        restoreForm(formId, button)

                    }
                }
            });
        } catch (error) {
            showToast(errorOccured?.message, '', errorOccured?.bgColor);
            restoreForm(formId, button)
            console.error(error);
        }
    }


    function deleteFunction(button, saveId) {
        try {
            disableButton(button);

            $.ajax({
                url: '/delete_emproles/' + saveId + '/',
                type: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                processData: false,
                contentType: false,
                success: function (response, status, xhr) {
                    if (xhr.status === 204) {
                        showToast(deleteMessage?.message, '', deleteMessage?.bgColor, true);
                        enableButton(button);

                    } else {
                        showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                        enableButton(button);

                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr, status, error);
                    if (xhr.status === 400) {
                        if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
                            showToast(xhr?.responseJSON?.details, '', errorAlertMessage?.bgColor);
                            enableButton(button);
                        } else {
                            showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                            enableButton(button);
                        }
                    }
                    else if (xhr.status === 401 || 404) {
                        showToast(xhr?.responseJSON?.details, '', errorAlertMessage?.bgColor);
                        enableButton(button);
                    }
                    else {

                        showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                        enableButton(button);
                    }
                }
            });
        } catch (error) {
            showToast(errorOccured?.message, '', errorOccured?.bgColor);
            console.error(error);
        }
    }


</script>

{% endblock header2 %}