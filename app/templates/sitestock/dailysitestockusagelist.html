{% extends "base.html" %}

{% load static %}

{% block header2 %}

<style>
	.badge.bg-success {
		background-color: green;
	}
	
	.badge.bg-primary {
		background-color: blue;
	}
	
	.badge.bg-danger {
		background-color: red;
	}
	
</style>

<!-- Begin page -->
<div id="layout-wrapper">

	<div class="main-content">

		<div class="page-content">
			<div class="container-fluid">

				<!-- start page title -->
				<div class="row">
					<div class="col-12">
						<div class="page-title-box d-sm-flex align-items-center justify-content-between">
							<h4 class="mb-sm-0"></h4>

							<div class="page-title-right">
								<ol class="breadcrumb m-0">
									<li class="breadcrumb-item"><a href="javascript: void(0);">Dashboard</a></li>
									<li class="breadcrumb-item active">daily Site Stock Usage</li>
								</ol>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-lg-12">
						<div class="card">
							<div class="card-header">

								<div class="row">
									<div class="col-xl-6 col-lg-6 col-md-6 col-12">
										<h2>Daily Site Stock Usage List </h2>
									</div>
									<div class="col-xl-4 col-lg-4 col-md-4 col-12"></div>
									<div class="col-xl-2 col-lg-2 col-md-2 col-12">
										<a href="{% url 'dailysitestockusage' %}" type="button" class="btn btn-info" 
											style="float:right;">Stock Update</a>

									</div>
									<div class="card-body">
										<div class="row">
											<div class="col-md-4 mb-3 mt-4" >
												<label for="project" class="form-label"> Project :</label>
												<select class="form-select" id="project" name="project">
													<!-- <option value="-1"> All </option> -->
													<option value="0">All</option>

													{% for project in projects %}

													<option value="{{ project.id }}">{{ project.proj_name }}</option>

													{% endfor %}
												</select>
												<span id="projectError" class="error-message"></span>
											</div>

											<!-- Subcontractor Dropdown -->
											<div class="col-md-4 mb-3 mt-4">
												<label for="subcontract" class="form-label">Subcontract:</label>
												<select class="form-select" id="subcontract" name="subcontract">
	
													<option value="0" selected>All</option>
	
													{% for subcontract in subcontracts %}
	
													<option value="{{ subcontract.id }}">{{subcontract.display_contractor_dropdown }}
														</option>
	
													{% endfor %}
												</select>
												<span id="subcontractError" class="error-message"></span>
											</div>
										<div class="col-xl-3 col-lg-3 col-md-3 col-xs-6 col-12">
											<br><br>
												<button type="submit" onclick="getReport(this,'example')"
												class="btn btn-primary waves-effect waves-light mt-2">Get Report
											</button>
											
										</div>
										<hr>
										<table id="example"
											class="table table-bordered dt-responsive nowrap table-striped align-middle"
											style="width:100%">
											<thead>
												<tr>

													<th data-ordering="false">S.No</th>
													<th data-ordering="false">Item name</th>
													<th data-ordering="false">Qty</th>
													<th data-ordering="false">Project</th>
													<th data-ordering="false">Subcontract</th>
													<th data-ordering="false">Unit</th>
													<th data-ordering="false" colspan="2">Status</th>
													<th data-ordering="false" >Action</th>

												</tr>
											</thead>
											<tbody>

											</tbody>

										</table>


										<div id="results-container"></div>
										<div id="pagination-container"></div>



									</div>
								</div>
							</div>
						</div>
						<!-- container-fluid -->
					</div>
					<!-- End Page-content -->


				</div>
				<!-- end main content-->

			</div>
			<!-- END layout-wrapper -->



			<div class="modal fade bs-example-modal-lg1" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
				aria-hidden="true" id="stockHistoryModal">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="myLargeModalLabel"> </h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<form id="editForm">
								<div class="row">
									<div class="row">
										<div class="col-4">
											<label for="item_name" class="form-label">Item Name</label>
											<input type="text" id="eitem" class="form-control" name="item" value="" disabled>
										</div>
										<div class="col-4 ">
											<label for="" class="form-label"> Qty</label>
											<input type="text" class="form-control" name="qty" value="" disabled>
										</div>

										<div class="col-4">
											<label for="unit" class="form-label">Unit</label>
											<input type="text" id="eunit" class="form-control" name="unit" value=""
												disabled>
										</div>

										<div class="col-4 mt-2">
											<label for="project" class="form-label">Project:</label>
											<select class="form-select" id="project" name="project">

												<option value="">--------</option>

												{% for project in projects %}
												<!--  -->
												<option value="{{ project.id }}">{{ project.proj_name }}</option>

												{% endfor %}
											</select>
											<span id="projectError" class="error-message"></span>
										</div>

										<div class="col-4 mt-2">
											<label for="subcontract" class="form-label">Subcontract:</label>
											<select class="form-select" id="subcontract" name="subcontract">

												<option value="0" selected>--------</option>

												{% for subcontract in subcontracts %}

												<option value="{{ subcontract.id }}">{{subcontract.display_contractor_dropdown }}
													</option>

												{% endfor %}
											</select>
											<span id="subcontractError" class="error-message"></span>
										</div>

									</div>
								</div>
							</form>

						</div>
						<div class="modal-footer">
							<button class="btn btn-link link-success fw-medium shadow-none" data-bs-dismiss="modal"><i
									class="ri-close-line me-1 align-middle"></i> Close</button>
							<button type="button" id="stockModal" class="btn btn-primary"
								onclick="updateHistory(this)">Save</button>
						</div>
					</div>

				</div>
			</div>
		</div>

		<!--start back-to-top-->
		<button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
			<i class="ri-arrow-up-line"></i>
		</button>
		<!--end back-to-top-->

		<!--preloader-->
		<div id="preloader">
			<div id="status">
				<div class="spinner-border text-primary avatar-sm" role="status">
					<span class="visually-hidden">Loading...</span>
				</div>
			</div>
		</div>


		<script>

			const existingPaginationContainer = document.getElementById('pagination-container');

			const dropdown = document.getElementById('project');
			const dropdown2 = document.getElementById('subcontract');
			const tableBody = document.querySelector('#example tbody');


			// // from and to
			// const fromdate = document.getElementById('fromdate');
			// const todate = document.getElementById('todate');

			// var qtyError = false;

			// var priceError = false;

			var currentPage = 1;

			document.addEventListener('DOMContentLoaded', function () {

				// const dropdown = document.getElementById('fromsite');
				// const tableBody = document.querySelector('#example tbody');

				// on dom loaded 
				const initialSelectedValue = dropdown.value;
				fetchData(1);

				// fetch table data API
				dropdown.addEventListener('change', function () {

					fetchData(currentPage);
				});

				dropdown2.addEventListener('change', function () {

					fetchData(currentPage);
				});

				// todate.addEventListener('change', function () {

				// 	fetchData(currentPage);
				// });

				// fromdate.addEventListener('change', function () {

				// 	fetchData(currentPage);
				// });

			});


			// fetch data
			function fetchData(page) {

				const selectedValue = dropdown.value;
				const subcontract = dropdown2.value;
				// const from = fromdate?.value || ""
				// const to = todate?.value || ""
				// console.log(fromdate ,todate)
				try {
					fetch(`/dailysitestockusagelist/${selectedValue}/?page=${page}&subcontract=${subcontract}`)
						.then(response => {
							if (response.ok) {
								console_log('Data fetched');
								return response.json();
							} else {
								throw new Error(`HTTP error! Status: ${response.status}`);
							}
						})
						.then(data => {
							tableBody.innerHTML = '';
							renderDataOrMessage(tableBody, data, page)
						})
						.catch(error => {
							console.error('Error fetching data:', error);
							showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
						});
				} catch (error) {
					console.error('Error in fetch operation:', error);
				}
			}



			// render table or message

			function renderDataOrMessage(data, page) {
				alert()
				if (data && Array.isArray(data.results) && data.results.length > 0) {
					data.results.forEach((item, index) => {
						const newRow = createTableRow(index + 1, item);
						tableBody.appendChild(newRow);
					});
					renderPagination(data, page);
				} else {
					tableBody.innerHTML = '<tr><td colspan="6">No data available.</td></tr>';
					existingPaginationContainer.innerHTML = '';
				}
			}



			const statusOptions = JSON.parse('{{ status_options|escapejs }}');

			function getStatusColor(statusCode) {
				switch (statusCode) {
					case "0":
						return 'badge bg-success'; 
					case "1":
						return 'badge bg-primary';  
					case "2":
						return 'badge bg-danger';  
					default:
						return 'badge bg-secondary'; 
				}
			}

			function updateStatus(itemId, newStatusId) {
				console.log(`Updating status for item ${itemId} to status ${newStatusId}`);
			}

			function createTableRow(serialNumber, data) {
				const newRow = document.createElement('tr');

				const serialCell = document.createElement('td');
				serialCell.textContent = serialNumber;
				newRow.appendChild(serialCell);

				const itemNameCell = document.createElement('td');
				itemNameCell.textContent = data.item_name;
				newRow.appendChild(itemNameCell);

				const qtyCell = document.createElement('td');
				qtyCell.textContent = data.qty;
				newRow.appendChild(qtyCell);

				const project_nameCell = document.createElement('td');
				project_nameCell.textContent = data.project_name;
				newRow.appendChild(project_nameCell);

				const subcontract_nameCell = document.createElement('td');
				subcontract_nameCell.textContent = data.subcontract_name;
				newRow.appendChild(subcontract_nameCell);

				const unit_nameCell = document.createElement('td');
				unit_nameCell.textContent = data.unit_name;
				newRow.appendChild(unit_nameCell);

				// Display status cell (without dropdown)
				const displayStatusCell = document.createElement('td');
				const displayStatusBadge = document.createElement('span');
				displayStatusBadge.id = `status-badge-${data.id}`;
				displayStatusBadge.className = `statustag badge align-middle fs-10 ${getStatusColor(data.status_code)}`;
				
				// Retrieve status from local storage if available
				const storedStatus = localStorage.getItem(`status-${data.id}`);
				if (storedStatus) {
					const { statusName, statusCode } = JSON.parse(storedStatus);
					displayStatusBadge.textContent = statusName;
					displayStatusBadge.className = `statustag badge align-middle fs-10 ${getStatusColor(statusCode)}`;
				} else {
					displayStatusBadge.textContent = data.status_name; 
				}
				
				displayStatusCell.appendChild(displayStatusBadge);
				newRow.appendChild(displayStatusCell);

				const changeStatusCell = document.createElement('td');
				const statusDiv = document.createElement('div');
				statusDiv.className = 'dropdown d-inline-block';

				const dropdownToggle = document.createElement('a');
				dropdownToggle.className = 'dropdown-toggle';
				dropdownToggle.href = '#';
				dropdownToggle.setAttribute('role', 'button');
				dropdownToggle.id = `dropdownMenuButton-${data.id}`;
				dropdownToggle.setAttribute('data-bs-toggle', 'dropdown');
				dropdownToggle.setAttribute('aria-expanded', 'false');
				statusDiv.appendChild(dropdownToggle);

				const dropdownMenu = document.createElement('ul');
				dropdownMenu.className = 'dropdown-menu status-dropdown';
				dropdownMenu.setAttribute('aria-labelledby', `dropdownMenuButton-${data.id}`);

				statusOptions.forEach(option => {
					const listItem = document.createElement('li');
					const dropdownItem = document.createElement('a');
					dropdownItem.className = 'dropdown-item';
					dropdownItem.href = '#';
					dropdownItem.textContent = option.fields.name;
					dropdownItem.setAttribute('data-status', option.pk);
					dropdownItem.setAttribute('data-id', data.id);

					// Event listener to handle status change
					dropdownItem.addEventListener('click', function(e) {
						e.preventDefault();
						const newStatusId = option.pk;
						const newStatusName = option.fields.name;
						
						// Update status visually with the name and color
						displayStatusBadge.textContent = newStatusName;
						displayStatusBadge.className = `statustag badge align-middle fs-10 ${getStatusColor(newStatusId)}`; // Update badge color

						// Store updated status in local storage
						localStorage.setItem(`status-${data.id}`, JSON.stringify({
							statusName: newStatusName,
							statusCode: newStatusId
						}));

						// Send the update to the backend
						updateStatus(data.id, newStatusId);
					});

					listItem.appendChild(dropdownItem);
					dropdownMenu.appendChild(listItem);
				});

				statusDiv.appendChild(dropdownMenu);
				changeStatusCell.appendChild(statusDiv);
				newRow.appendChild(changeStatusCell);

				// Action cell (for other actions, such as viewing details)
				const actionCell = document.createElement('td');
				actionCell.innerHTML = `<button class="btn btn-soft-secondary btn-sm dropdown" type="button" onclick="openCustomDataModal('stockHistoryModal')">
					<i class="ri-eye-fill align-middle"></i>
				</button>`;
				actionCell.addEventListener('click', () => {
					populateModalData(data);
				});
				newRow.appendChild(actionCell);

				return newRow;
			}

























			// populate data in modal
			function populateModalData(data) {
				const formId = 'editForm'
				var formElement = document.getElementById(formId);

				// modalheader.innerText = `${data.labour_name} details`

				const I1 = formElement.querySelector('input[name="qty"]')
				I1.value = data.qty;

				const I2 = formElement.querySelector('input[name="item"]')
				I2.value = data.item_name;

				const I3 = formElement.querySelector('select[name="project"]')
				I3.value = data.project
				const projectOption = I3.querySelector(`option[value="${data.project}"]`);
				if (projectOption) {
					projectOption.selected = true;
				}


				//const I4 = formElement.querySelector('input[name="unit"]')
				//I4.value = data.unit_name;

				const I4 = formElement.querySelector('input[name="unit"]');
    			I4.value = data.unit_name;

				// const I5 = formElement.querySelector('select[name="subcontract_name"]')
				// I5.selected = data.subcontract;

				const I5 = formElement.querySelector('select[name="subcontract"]');
				I5.value = data.subcontract
				const selectedOption = I5.querySelector(`option[value="${data.subcontract}"]`);
				if (selectedOption) {
					selectedOption.selected = true;
				}

				const saveButton = document.querySelector('#stockModal');   //id change
				saveButton.setAttribute("data-id", data.id)



			}





			// update api call



			function updateHistory(button) {

				var modalSelector = button.getAttribute('data-target');
				const formId = "editForm"

				const saveId = button.getAttribute('data-id')
				var formElement = document.getElementById(formId);

				var formData = new FormData();
				try {
					disableButton(button);
					var isValid = true;
					var errors = {};
					var formData = new FormData();

					var requiredKeys = [];   //changes
					console_log(formElement)

					const subcontract_name = getValueOrDefault(formElement.querySelector('select[name="subcontract"]').value);
					const project_name = getValueOrDefault(formElement.querySelector('select[name="project"]').value);
					//const qty = getValueOrDefault(formElement.querySelector('input[name="qty"]').value);
					//const unit_name = getValueOrDefault(formElement.querySelector('input[name="unit"]').value);
					//const item_name = getValueOrDefault(formElement.querySelector('input[name="item"]').value);



					if (subcontract_name) {
					 	formData.append('subcontract', subcontract_name);
				    }

					if (project_name) {
						formData.append('project', project_name);
					}

					// if (unit_name) {
					// 	formData.append('unit', unit_name);

					// }
					//if (qty) {
					//	formData.append('qty', qty);

					//}
					//if (item_name) {
					//	formData.append('item', item_name);

					//}




					requiredKeys.forEach(function (key) {
						var value = formData.get(key);
						if (!value.trim()) {
							isValid = false;
							errors[key] = ['This field is required.'];
						}
					});

					if (!isValid) {
						enableButton(button);
						// console.log(errors);
						handleCreateErrors(errors);
						return;
					} else {
						$(`#${formId} input, #${formId} button`).prop('disabled', true);

					}

					$.ajax({
						url: `/update_sitestockusage/${saveId}/`,                //change
						type: 'PUT',
						headers: {
							'X-CSRFToken': csrftoken,
						},
						data: formData,
						processData: false,
						contentType: false,
						success: function (response, status, xhr) {
							console.error(status);
							if (xhr.status === 200) {

								showToast(successMesssage?.message, '', successMesssage?.bgColor);
								fetchData(currentPage, reload = true)
								closeHistoryModal(modalSelector)
								// restoreForm(formId, button)

							} else {

								// restoreForm(formId, button)
								showToast(
									errorAlertMessage?.message,
									"",
									errorAlertMessage?.bgColor
								);

							}
						},
						error: function (xhr, status, error) {
							// console.log(xhr, status, error);
							if (xhr.status === 400) {
								if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
									handleCreateErrors(transformErrors(xhr.responseJSON));
									// restoreForm(formId, button)


								} else {
									showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
									// restoreForm(formId, button)

								}
							}
							else if (xhr.status === 401 || xhr.status === 404) {

								showToast(xhr?.responseJSON?.details || errorOccured.message, '', errorAlertMessage?.bgColor);
								// restoreForm(formId, button)


							}
							else {
								showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
								// restoreForm(formId, button)

							}
						}
					});
				} catch (error) {
					showToast(errorOccured?.message, '', errorOccured?.bgColor);
					// restoreForm(formId, button)
					console.error(error);
				}
				finally {
					restoreForm(formId, button)
				}

			}














// Function to send an AJAX request to update the status
function updateStatus(itemId, newStatusId) {
    fetch('/update-stock-status/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCSRFToken(), // Add CSRF token for security
        },
        body: new URLSearchParams({
            'id': itemId,
            'status': newStatusId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Status updated successfully:', data.status_name);
            // Update the status badge visually with the new status
            const statusBadge = document.getElementById(`status-badge-${itemId}`);
            statusBadge.textContent = data.status_name; // Update to new status name
            statusBadge.className = `${getStatusColor(data.status_code)} align-middle fs-10`; // Update badge color
        } else {
            console.error('Failed to update status:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// Function to get CSRF token from cookies
function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === 'csrftoken=') {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}

dropdownItem.addEventListener('click', function(e) {
    e.preventDefault();
    const newStatusId = option.pk;
    const newStatusName = option.fields.name;
    
    // Update status visually with the name and color
    displayStatusBadge.textContent = newStatusName;
    displayStatusBadge.className = `statustag badge align-middle fs-10 ${getStatusColor(newStatusId)}`; // Update badge color

    // Store updated status in local storage
    localStorage.setItem(`status-${data.id}`, JSON.stringify({
        statusName: newStatusName,
        statusCode: newStatusId
    }));

    // Send the update to the backend
    updateStatus(data.id, newStatusId);

    // Disable action button if status is "Approved"
    if (newStatusName.toLowerCase() === 'approved') {
        actionCell.querySelector('button').disabled = true;
    } else {
        actionCell.querySelector('button').disabled = false; // Ensure it's enabled for other statuses
    }
});

// Inside createTableRow function
// Check initial status from local storage
const storedStatus = localStorage.getItem(`status-${data.id}`);
if (storedStatus) {
    const { statusName, statusCode } = JSON.parse(storedStatus);
    displayStatusBadge.textContent = statusName;
    displayStatusBadge.className = `statustag badge align-middle fs-10 ${getStatusColor(statusCode)}`;
    
    // Disable action button if status is "Approved"
    if (statusName.toLowerCase() === 'approved') {
        actionCell.querySelector('button').disabled = true;
    }
} else {
    displayStatusBadge.textContent = data.status_name;
}



		</script>


		{% endblock header2 %}
