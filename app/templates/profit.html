{% extends "base.html" %}

{% load static %}

{% block header2 %}

<!-- Begin page -->
<div id="layout-wrapper">


    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                            <h4 class="mb-sm-0">Profit & Loss </h4>

                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboard</a></li>
                                    <li class="breadcrumb-item active">P & L</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">

                                <div class="row">
                                    <div class="col-xl-6 col-lg-6 col-md-6 col-12">
                                        <h2>Profit & Loss </h2>
                                    </div>
                                    <div class="col-xl-4 col-lg-4 col-md-4 col-12"></div>
                                    <div class="col-xl-2 col-lg-2 col-md-2 col-12">
                                        <!-- <button type="button" class="btn btn-info" style="float:right;"
                                            data-bs-toggle="modal"
                                            data-bs-target=".bs-example-modal-lg">calculate</button> -->
                                        <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog"
                                            aria-labelledby="myLargeModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="myLargeModalLabel">Profit & Loss
                                                        </h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close">
                                                        </button>
                                                    </div>
                                                    <hr>
                                                    <div class="modal-body">
                                                        <div class="row">
                                                            <div class="col-md-4">
                                                                <label for="" class="form-label">site Name :</label>
                                                                <select class="form-select mb-3"
                                                                    aria-label="Default select example">
                                                                    <option selected>site Name </option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label for="" class="form-label">Estimation cost
                                                                    :</label>
                                                                <input type="text" class="form-control" id="">
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label for="" class="form-label">Material cost :</label>
                                                                <input type="text" class="form-control" id="">
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label for="" class="form-label">Salary cost :</label>
                                                                <input type="text" class="form-control" id="">
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label for="" class="form-label">Other Expenses
                                                                    :</label>
                                                                <input type="text" class="form-control" id="">
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label for="" class="form-label">Calculate :</label>
                                                                <br><button type="button"
                                                                    class="btn btn-primary waves-effect waves-light">calculate</button>
                                                            </div>
                                                        </div>
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <label for="" class="form-label">Profit Amount :</label>
                                                                <input type="text" class="form-control" id="">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="" class="form-label">Status :</label>
                                                                <input type="text" class="form-control" id="">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <hr>
                                                    <div class="modal-footer">
                                                        <button class="btn btn-link link-success fw-medium shadow-none"
                                                            data-bs-dismiss="modal"><i
                                                                class="ri-close-line me-1 align-middle"></i>
                                                            Close</button>
                                                        <button type="button" class="btn btn-primary ">Save </button>
                                                    </div>
                                                </div>
                                                <!-- /.modal-content -->
                                            </div>
                                            <!-- /.modal-dialog -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- <div class="col-xl-3 col-lg-3 col-md-3 col-xs-6 col-12">
                                    <label for="" class="form-label">Employee :</label> -->

                            <select class="form-select mb-3" aria-label="Default select example" id="filterdropdown1"
                                hidden>
                                <option value="0"> ------------ </option>
                                {% for i in employees %}
                                <option value="{{i.id}}">{{i.name}} </option>
                                {% endfor %}
                            </select>

                            <!-- </div> -->

                            


                            <div class="card-body">


                                <table id="example"
                                    class="table table-bordered dt-responsive nowrap table-striped align-middle"
                                    style="width:100%">
                                    <thead>
                                        <tr>
                                            <!-- <th scope="col" style="width: 10px;">
                                                    <div class="form-check">
                                                        <input class="form-check-input fs-15" type="checkbox" id="checkAll" value="option">
                                                    </div>
                                                </th> -->
                                            <th data-ordering="false">S No.</th>
                                            <th data-ordering="false">site Name</th>
                                            <th data-ordering="false">Estimation</th>
                                            <th data-ordering="false">Material Amount</th>
                                            <th data-ordering="false">Salary expenses</th>
                                            <th data-ordering="false">SubContract expenses</th>
                                            <th data-ordering="false">Other Expenses</th>
                                            <th data-ordering="false">P & L Amount</th>
                                            <!-- <th data-ordering="false">Status</th>  -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- <tr>
                                                <th scope="row">
                                                    <div class="form-check">
                                                        <input class="form-check-input fs-15" type="checkbox" name="checkAll" value="option1">
                                                    </div>
                                                </th>
                                                <td>01</td>
												<td>Ayikudy</td>
                                                <td>1000000</td>
                                                <td>500000</td>                                               
                                                <td>300000</td>                                               
                                                <td>50000</td>                                               
                                                <td>150000</td>
                                                <td>Profit</td>
                                            </tr> -->

                                    </tbody>
                                </table>

                                <div id="pagination-container"></div>

                            </div>
                        </div>
                    </div>
                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->


        </div>
        <!-- end main content-->

    </div>
    <!-- END layout-wrapper -->



    <!--start back-to-top-->
    <button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
        <i class="ri-arrow-up-line"></i>
    </button>
    <!--end back-to-top-->

    <!--preloader-->
    <div id="preloader">
        <div id="status">
            <div class="spinner-border text-primary avatar-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>




    <script>

        let activePage;

        // fetch url
        let fetchUrl = "profit-loss"

        // pagination
        const existingPaginationContainer = document.getElementById('pagination-container');

        // table
        const tableBody = document.querySelector('#example tbody');

        // filters 
        const firstDropdown = document.getElementById('filterdropdown1');
        const fromdate = document.getElementById('fromDate');
        // const todate = document.getElementById('toDate');

        var currentPage = 1;

        document.addEventListener('DOMContentLoaded', function () {

            // on dom loaded 
            const initialSelectedValue = firstDropdown.value;
            fetchData(1);

            // fetch table data API
            firstDropdown.addEventListener('change', function () {

                activePage = null
                fetchData(currentPage);
            });

            // todate.addEventListener('change', function () {
            //     activePage = null
            //     fetchData(currentPage);
            // });

            // fromdate.addEventListener('change', function () {
            //     activePage = null
            //     fetchData(currentPage);
            // });


        });


        // fetch data
        function fetchData(page) {

            if (activePage === page) {
                return
            }
            const selectedValue = firstDropdown?.value || 0;
            const from = fromdate?.value ? `${fromdate?.value}-15` : ""
            const to = ""
            try {
                fetch(`/${fetchUrl}/${selectedValue}/?page=${page}&salary_date=${from}&end_date=${to}`)
                    .then(response => {
                        if (response.status === 200) {
                            console.log('Data fetched');
                            return response.json();
                        } else if (response.status === 404) {
                            throw new Error('Resource not found');
                        } else if (response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        } else {
                            throw new Error('Network response was not ok');
                        }
                    })
                    .then(data => {
                        tableBody.innerHTML = '';
                        renderDataOrMessage(tableBody, data, page)
                        activePage = page
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                    });
            } catch (error) {
                console.error('Error in fetch operation:', error);
            }
        }





        // MANIPULATE TABLE DATA
        function createTableRow(serialNumber, data) {

            const newRow = document.createElement('tr');
            newRow.setAttribute('data-item-id', data.id);

            const idCell = createSerialCell(serialNumber);
            newRow.appendChild(idCell);

            // const td2 = createTableCell(get_value(data.created_at));
            // newRow.appendChild(td2);

            const td3 = createTableCell(get_value(data.proj_name));
            newRow.appendChild(td3);

            const td4 = createAmountCell(get_value(data.estimation));
            newRow.appendChild(td4);

            const td5 = createAmountCell(get_value(data.material_expense));
            newRow.appendChild(td5);

            const td6 = createAmountCell(get_value(data.salary_expense));
            newRow.appendChild(td6);

            const td7 = createAmountCell(get_value(data.subcontract_expense));
            newRow.appendChild(td7);

            const td8 = createAmountCell(get_value(data.other_expense));
            newRow.appendChild(td8);

            const td9 = createProfitLossCell(get_value(data.profit_or_loss));
            newRow.appendChild(td9);





            return newRow;
        }


        // <span class="badge bg-success text-dark mb-0">
        //                                                         <i class="ri-arrow-up-line align-middle"></i>
        //                                                             27
        //                                                         </span>
        //                                                         <span class="badge bg-danger text-dark mb-0">
        //                                                         <i class="ri-arrow-down-line align-middle"></i>
        //                                                             27
        //                                                         </span>


        function createProfitLossCell(value) {
            const cell = document.createElement('td');
            const span = document.createElement('span');

            const i =  document.createElement('i')

            span.textContent = value;

            if (parseFloat(value) > 0) {
                // span.classList.add("badge", "bg-success", "text-dark", "mb-0");
                span.classList.add("badge", "bg-success-subtle" ,"text-success" ,"fs-12");
                i.classList.add("ri-arrow-up-s-line", "fs-13" ,"align-middle", "me-1");

            } else if (parseFloat(value) < 0) {
                // span.classList.add("badge", "bg-danger", "text-dark", "mb-0");
                span.classList.add("badge", "bg-danger-subtle", "text-danger", "fs-12");
                i.classList.add("ri-arrow-down-s-line", "fs-13" ,"align-middle", "me-1");
 
                // i.classList.add("ri-arrow-down-line" , "align-middle");
            }
            span.appendChild(i)
            cell.appendChild(span)

            return cell;
        }



    </script>

    {% endblock header2 %}