{% extends "base.html" %} {% load static %} {% block header2 %}

<div id="layout-wrapper">
  <div class="main-content">
    <div class="page-content">
      <div class="container-fluid">
        <!-- start page title -->
        <div class="row">
          <div class="col-12">
            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
              <h4 class="mb-sm-0">Site Allocation Management</h4>
              <div class="page-title-right">
                <ol class="breadcrumb m-0">
                  <li class="breadcrumb-item">
                    <a href="javascript: void(0);">Dashboard</a>
                  </li>
                  <li class="breadcrumb-item active">Labour</li>
                </ol>
              </div>
            </div>
          </div>
        </div>
    
        <div class="row">
          <div class="col-lg-12">
            <div class="card">
              

              <div class="card-header">

                <div class="row">
                    <div class="col-xl-6 col-lg-6 col-md-6 col-12">
                        <h4>Labour</h4>
                    </div>
                    <div class="col-xl-4 col-lg-4 col-md-4 col-12"></div>
                    <div class="col-xl-2 col-lg-2 col-md-2 col-12">
                        <button type="button" class="btn btn-info" style="float:right;"
                            data-bs-toggle="modal" data-bs-target=".bs-example-modal-lg">+ Add
                           </button>
                        <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog"
                            aria-labelledby="myLargeModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <form id="createForm" enctype="multipart/form-data">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="myLargeModalLabel">Labour Site Allocation
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close" onclick="clearErrors()">
                                            </button>
                                        </div>
                                        <hr>
                                        <div class="modal-body">

                                            {% csrf_token %}
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label for="id_date" class="form-label">Date <span style="color: red;">*</span> </label>
                                                    <input type="date" name="date" class="form-control"
                                                        id="date" value="">
                                                    <span id="dateError" class="error-message"></span>
                                                </div>

                                                <div class="col-md-6">
                                                    <label for="" class="form-label">Select Labour
                                                      <span style="color: red;">*</span></label>
                                                    <select class="form-select mb-3"
                                                        aria-label="Default select example"
                                                        name="labour" id="labour">

                                                        <option value=""> ---------------- </option>
                                                        {% for i in employee %}
                                                        <option value="{{i.id}}">{{i.name}} </option>
                                                        {% endfor %}

                                                    </select>
                                                    <span id="labourError"
                                                        class="error-message"></span>
                                                </div>

                                                <div class="col-md-6">
                                                    <label for="" class="form-label">Select Project
                                                      <span style="color: red;">*</span></label>
                                                    <select class="form-select mb-3"
                                                        aria-label="Default select example"
                                                        name="project" id="project">

                                                        <option value="">----------------</option>
                                                        {% for i in project %}
                                                        <option value="{{i.id}}">{{i.proj_name}} </option>
                                                        {% endfor %}

                                                    </select>
                                                    <span id="projectError"
                                                        class="error-message"></span>
                                                </div>
                                           
                                                

                                            </div>
                                        </div>
                                        <hr>
                                        <div class="modal-footer">
                                            <button class="btn btn-link link-success fw-medium shadow-none"
                                                data-bs-dismiss="modal"><i
                                                    class="ri-close-line me-1 align-middle"
                                                    onclick="clearErrors()"></i> Close</button>
                                            <button type="button" class="btn btn-primary "
                                                onclick="createFunction(this)">Save </button>
                                        </div>
                                    </form>
                                </div>
                                <!-- /.modal-content -->
                            </div>
                            <!-- /.modal-dialog -->
                        </div>
                    </div>
                </div>
            </div>



              <div class="card-body">
                <div class="row">
                  <div class="col-xl-2 col-lg-2 col-md-2 col-xs-6 col-12">
                    <label for="" class="form-label">Labour Name :</label>
                    <select class="form-select mb-3" aria-label="Default select example" id="labourdropdown">

                      <option value="0"> ------------ </option>
                      <!-- <select id="contractor" class="form-control mb-3" data-live-search="true"> -->
                      {% for i in employee %}
                      <option value="{{i.id}}"> {{i.name}} </option>
                      {% endfor %}
                    </select>
                  </div>
                  {% comment %} <div class="col-xl-2 col-lg-2 col-md-2 col-xs-6 col-12">
                    <label for="" class="form-label">Project Name :</label>
                    <select class="form-select mb-3" aria-label="Default select example"  id="dropdown">
                        <option value="0"> ------------ </option>
                        {% for i in project %}
                        <option value="{{i.id}}">{{i.proj_name}} </option>
                        {% endfor %}

                    </select>
                    
                </div> {% endcomment %}

                  <div class="col-xl-2 col-lg-2 col-md-2 col-xs-6 col-12">
                    <label for="exampleInputdate" class="form-label">From Date</label>
                    <input type="date" class="form-control" id="fromdate" />
                  </div>

                  <div class="col-xl-2 col-lg-2 col-md-2 col-xs-6 col-12">
                    <label for="exampleInputdate" class="form-label">To Date</label>
                    <input type="date" class="form-control" id="todate" />
                  </div>

                  <div class="col-xl-3 col-lg-3 col-md-3 col-xs-6 col-12">
                    <br />
                    <button type="submit" onclick="getReport(this,'example')"
                    class="btn btn-primary waves-effect waves-light mt-2">Get Report
                </button>
                  </div>
                </div>
                <hr />
                <table id="example" 
                  style="width: 100%">
                  <thead>
                    <tr>
                      <th data-ordering="false">SR No.</th>
                      <th data-ordering="false"> Date </th>
                      <th data-ordering="false">Project Name </th>
                      <th data-ordering="false">Labour Name</th>
                      <th data-ordering="false">Created By</th>
                      <th data-ordering="false">Action</th>
                    </tr>
                  </thead>
                  <tbody id='modalTableBody'>

                  </tbody>
                </table>

                <div id="pagination-container"></div>

              </div>



            </div>
          </div>
        </div>
        <!-- container-fluid -->
      </div>
      <!-- End Page-content -->
    </div>
    <!-- end main content-->
  </div>
  <!-- END layout-wrapper -->
</div>

<div
  class="modal fade"
  id="editModal"
  tabindex="-1"
  aria-labelledby="editModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Site Allocation</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <div class="mb-3">
            <label for="editDateInput" class="form-label">Date:</label>
            <input
              type="date"
              class="form-control"
              id="editDateInput"
              name="date"
            />
          </div>

          <div class="mb-3">
            <label for="editProjectSelect" class="form-label"
              >Select Project:</label
            >
            <select
              class="form-select"
              aria-label="Default select example"
              id="{{i.id}}_editProjectSelect"
              name="project"
            >
              <option value="{{i.project.id}}" selected>
                {{i.project.proj_name}}
              </option>
              <option>-----------</option>
              {% for project_option in project %}
              <option value="{{project_option.id}}">
                {{project_option.proj_name}}
              </option>
              {% endfor %}
            </select>
            <span id="{{i.id}}_editProjectError" class="error-message"></span>
          </div>

          <div class="mb-3">
            <label for="editLabourSelect" class="form-label"
              >Select Labour:</label
            >
            <select
              class="form-select"
              aria-label="Default select example"
              id="{{i.id}}_editLabourSelect"
              name="labour"
            >
              <option value="{{i.labour.id}}" selected>
                {{i.labour.name}}
              </option>
              <option>-----------</option>
              {% for i in employee %}
              <option value="{{i.id}}">{{i.name}}</option>
              {% endfor %}
            </select>
            <span id="{{i.id}}_editLabourError" class="error-message"></span>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>

        <button
          type="button"
          data-target="editModal"
          class="btn btn-primary"
          onclick="updateFunction(this)"
          id="saveChangesButton"
        >
          Save changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this item?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
      </div>
    </div>
  </div>
</div>

<button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
  <i class="ri-arrow-up-line"></i>
</button>

<div id="preloader">
  <div id="status">
    <div class="spinner-border text-primary avatar-sm" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<script>

  document.addEventListener("DOMContentLoaded", function () {
    const viewButtons = document.querySelectorAll(".view-btn");
    const editButtons = document.querySelectorAll(".edit-btn");
    const delButtons = document.querySelectorAll(".del-btn");

    viewButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const modalId = this.getAttribute("data-target");
        const modal = document.querySelector(modalId);
        if (modal) {
          $(modal).modal("show");
        }
      });
    });

    editButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const modalId = this.getAttribute("data-target");
        const modal = document.querySelector(modalId);
        if (modal) {
          $(modal).modal("show");
        }
      });
    });

    delButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const modalId = this.getAttribute("data-target");
        const modal = document.querySelector(modalId);
        if (modal) {
          $(modal).modal("show");
        }
      });
    });
  });

  // create form

  function createFunction(button) {
    var formId = `createForm`; //change
    var formElement = document.getElementById(formId);
    clearErrors()

    try {
      disableButton(button);
      var isValid = true;
      var errors = {};
      var formData = new FormData();

      var requiredKeys = ["date","project","labour"];

      formData.append(
        "date",
        getValueOrDefault(formElement.querySelector('input[name="date"]').value)
      );
      formData.append(
        "project",
        getValueOrDefault(
          formElement.querySelector('select[name="project"]').value
        )
      );
      formData.append(
        "labour",
        getValueOrDefault(
          formElement.querySelector('select[name="labour"]').value
        )
      );
    


      requiredKeys.forEach(function (key) {
        var value = formData.get(key);
        if (!value.trim()) {
          isValid = false;
          errors[key] = ["This field may not be blank."];
        }
      });

      if (!isValid) {
        enableButton(button);
        console.log(errors);
        handleCreateErrors(errors);
        return;
      } else {
        $(`#${formId} input, #${formId} button`).prop("disabled", true);
      }

      $.ajax({
        url: "/add_site_allocation/", //change
        type: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
        },
        data: formData,
        processData: false,
        contentType: false,
        success: function (response, status, xhr) {
          console.error(status);
          if (xhr.status === 201) {
            showToast(
              successMesssage?.message,
              "",
              successMesssage?.bgColor,
              true
            );
          } else {
            console.error(error);
            restoreForm(formId, button);
          }
        },
        error: function (xhr, status, error) {
          console.log(xhr, status, error);
          console.log(xhr.status)
          if (xhr.status === 400) {
            // alert(1)
            if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
              handleCreateErrors(transformErrors(xhr.responseJSON));
              restoreForm(formId, button);
            } else {
              showToast(
                errorAlertMessage?.message,
                "",
                errorAlertMessage?.bgColor
              );
              restoreForm(formId, button);
            }
          } else if (xhr.status === 401 || xhr.status === 404 || xhr.status === 409) {
            // alert(2,xhr.status )
            console.log(xhr.status)
            showToast(
              xhr?.responseJSON?.details,
              "",
              errorAlertMessage?.bgColor
            );
            restoreForm(formId, button);
          } else {
            // alert(3)
            showToast(
              errorAlertMessage?.message,
              "",
              errorAlertMessage?.bgColor
            );
            restoreForm(formId, button);
          }
        },
      });
    } catch (error) {
      // alert()
      showToast(errorOccured?.message, "", errorOccured?.bgColor);
      restoreForm(formId, button);
      console.error(error);
    }




  }

</script>

<script>

  function updateFunction(button) {

    var modalSelector = button.getAttribute('data-target');
    const formId = "editForm"

    const saveId = button.getAttribute('data-id')
    var formElement = document.getElementById(formId);

    var formData = new FormData();
    try {
      disableButton(button);
      var isValid = true;
      var errors = {};
      var formData = new FormData();

      var requiredKeys = ['date'];   //change


      const date = getValueOrDefault(formElement.querySelector('input[name="date"]').value);
      const project = getValueOrDefault(formElement.querySelector('select[name="project"]').value);
      const labour = getValueOrDefault(formElement.querySelector('select[name="labour"]').value);
      //const created_by = getValueOrDefault(formElement.querySelector('input[name="created_by"]').value);

      formData.append('date', date);

      if(project){
        formData.append('project', project);
      }

      if (labour){
          formData.append('labour', labour);
      }

      formData.append('date', date)
      formData.append('labour', labour)



      requiredKeys.forEach(function (key) {
        var value = formData.get(key);
        if (!value.trim()) {
          isValid = false;
          errors[key] = ['This field is required.'];
        }
      });

      if (!isValid) {
        enableButton(button);
        // console.log(errors);
        handleCreateErrors(errors);
        return;
      } else {
        $(`#${formId} input, #${formId} button`).prop('disabled', true);

      }

      $.ajax({
        url: `/site_allocationlabour/${saveId}/`,                //change
        type: 'PUT',
        headers: {
          'X-CSRFToken': csrftoken,
        },
        data: formData,
        processData: false,
        contentType: false,
        success: function (response, status, xhr) {
          console.error(status);
          if (xhr.status === 200) {

            showToast(updateMessage?.message, '', updateMessage?.bgColor);
            fetchData(currentPage, reload = true)
            closeHistoryModal(modalSelector)
            restoreForm(formId, button)

          } else {

            restoreForm(formId, button)
            showToast(
              errorAlertMessage?.message,
              "",
              errorAlertMessage?.bgColor
            );

          }
        },
        error: function (xhr, status, error) {
          // console.log(xhr, status, error);
          if (xhr.status === 400) {
            if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
              handleCreateErrors(transformErrors(xhr.responseJSON));
              restoreForm(formId, button)


            } else {
              showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
              restoreForm(formId, button)

            }
          }
          else if (xhr.status === 401 || xhr.status ===  404) {

            showToast(xhr?.responseJSON?.details || errorOccured.message, '', errorAlertMessage?.bgColor);
            restoreForm(formId, button)


          }
          else {
            showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor); 
            restoreForm(formId, button)

          }
        }
      });
    } catch (error) {
      showToast(errorOccured?.message, '', errorOccured?.bgColor);
      restoreForm(formId, button)
      console.error(error);
    }

  }

   // Function to populate the form with data from the server
   function populateEditForm(itemId) {
    $.ajax({
        url: `/site_allocationlabour/${itemId}/`,
        type: 'GET',
        success: function(response) {
            console.log("Data fetched for item ID:", itemId); // Debugging log
            $('#editDateInput').val(response.date);
            
        },
        error: function(xhr, status, error) {
            console.error(xhr, status, error);
        }
    });
  }


  // Event listener for the "Edit" button click
  $(document).on('click', '.edit-item-btn', function() {
    const itemId = $(this).closest('tr').data('item-id'); // Assuming each row has a data-item-id attribute
    openModal('editModal', itemId);
  });

  // Ensure the event listener for the save button in the modal
  document.getElementById('saveChangesButton').addEventListener('click', function() {
    const itemId = document.getElementById('editForm').getAttribute('data-item-id');
    updateFunction(this, itemId);
  });


</script>

<script>

  let activePage;

  const existingPaginationContainer = document.getElementById(
    "pagination-container"
  );

  const dropdown = document.getElementById("labourdropdown");
  const tableBody = document.querySelector("#example tbody");

  // from and to


  console.log(dropdown, "ppppppppp"

  )

  const modalfromdate = document.getElementById("fromdate");
  const modaltodate = document.getElementById("todate");

  var qtyError = false;

  var priceError = false;

  var currentPage = 1;

  document.addEventListener("DOMContentLoaded", function () {
    // const dropdown = document.getElementById('fromsite');
    // const tableBody = document.querySelector('#example tbody');

    // on dom loaded
    const initialSelectedValue = dropdown.value;
    fetchData(1);

    // fetch table data API
    dropdown.addEventListener("change", function () {
      activePage = null;
      fetchData(currentPage);
    });



    modalfromdate.addEventListener("change", function () {
      activePage = null;
      fetchData(currentPage);
    });

    modaltodate.addEventListener("change", function () {
      activePage = null;
      fetchData(currentPage);
    });
  });

  // fetch data
  function fetchData(page) {
    currentPage = page;
    const selectedValue = dropdown.value;
    const from = fromdate?.value || "";
    const to = todate?.value || "";

    try {
      fetch(
        `/lab-site-allocation-list/${selectedValue}/?page=${page}&start_date=${from}&end_date=${to}`
      ) //CHANGE URL
        .then((response) => {
          if (response.status === 200) {
            console.log("Data fetched");
            return response.json();
          } else if (response.status === 404) {
            throw new Error("Resource not found");
          } else if (response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          } else {
            throw new Error("Network response was not ok");
          }
        })
        .then((data) => {
          tableBody.innerHTML = "";
          renderDataOrMessage(tableBody, data, page);
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
          showToast(errorAlertMessage?.message, "", errorAlertMessage?.bgColor);
        });
    } catch (error) {
      console.error("Error in fetch operation:", error);
    }
  }

  // render table or message

  function renderDataOrMessage(tableBody, data, page) {
    // Check if data is available and not empty
    if (data && Array.isArray(data.results) && data.results.length > 0) {
      // Render the data in the table

      tdata = data?.results;

      tdata.forEach((item, index) => {
        const newRow = createTableRow(index + 1, item);
        tableBody.appendChild(newRow);
      });

      renderPagination(data, page);
    } else {
      // Display a message indicating no data available
      tableBody.innerHTML = '<tr><td colspan="6">No data available.</td></tr>';

      existingPaginationContainer.innerHTML = ""; // Clear existing content
    }
  }

  // MANIPULATE TABLE DATA
  function createTableRow(serialNumber, data) {
    const newRow = document.createElement("tr");
    newRow.setAttribute("data-item-id", data.id);

    //seriaal number
    const td1 = document.createElement("td");
    td1.textContent = serialNumber;
    newRow.appendChild(td1);

    // date
    const td2 = document.createElement("td");
    td2.textContent = get_value(data.date);
    newRow.appendChild(td2);

    // particular
    const td3 = document.createElement("td");
    td3.textContent = get_value(data.project_name);
    td3.setAttribute('data-id', data.project ?? null)
    newRow.appendChild(td3);

    // From amount
    const td4 = document.createElement("td");
    td4.textContent = get_value(data.labour_name);
    newRow.appendChild(td4);

    // From amount
    const td5 = document.createElement("td");
    td5.textContent = get_value(data.created_by_name);
    newRow.appendChild(td5);

    // Dropdown button cell
    const dropdownButtonCell = document.createElement("td");
    const dropdownButton = document.createElement("button");
    dropdownButton.className = "btn btn-soft-secondary btn-sm dropdown";
    dropdownButton.setAttribute("type", "button");
    dropdownButton.setAttribute("data-bs-toggle", "dropdown");
    dropdownButton.setAttribute("aria-expanded", "false");

    const dropdownIcon = document.createElement("i");
    dropdownIcon.className = "ri-more-fill align-middle";

    dropdownButton.appendChild(dropdownIcon);
    dropdownButtonCell.appendChild(dropdownButton);

    // Dropdown menu
    const dropdownMenu = document.createElement("ul");
    dropdownMenu.className = "dropdown-menu dropdown-menu-end";


    // Edit option
    const editOption = document.createElement("li");
    const editLink = document.createElement("a");
    editLink.className = "dropdown-item edit-item-btn";
    editLink.textContent = "Edit";
    editLink.setAttribute("data-bs-toggle", "modal");
    editLink.setAttribute("href", "#!");
    editLink.addEventListener("click", () => {
        console.log("Edit button clicked for item ID:", data.id); // Debugging log
        //openModal("editModal", data.id);
        openHistoryModal("editModal")
        payModalData (data)
    });
    editOption.appendChild(editLink);
    dropdownMenu.appendChild(editOption);

    const deleteOption = document.createElement("li");
    const deleteLink = document.createElement("a");
    deleteLink.className = "dropdown-item remove-item-btn del-btn";
    deleteLink.textContent = "Delete";
    deleteLink.setAttribute("href", "#!");
    deleteLink.addEventListener('click', () => {
      openDeleteModal("deleteModal", data.id);
    });
    deleteOption.appendChild(deleteLink);
    dropdownMenu.appendChild(deleteOption);

    dropdownButtonCell.appendChild(dropdownMenu);
    newRow.appendChild(dropdownButtonCell);

    return newRow;
  }

  function payModalData(data) {
    const formId ='editForm'

    var formElement = document.getElementById(formId);

    const date = formElement.querySelector('input[name="date"]');
    date.value = data.date;

    const project = formElement.querySelector('select[name="project"]');
    project.value = data.project;

    const labour = formElement.querySelector('select[name="labour"]');
    labour.value = data.labour;



    // Add event listener to Save button
    const saveButton = document.querySelector('#saveChangesButton');   //id change
    saveButton.setAttribute("data-id", data.id)

  }

  function openDeleteModal(modalId, itemId) {
    const deleteModal = new bootstrap.Modal(document.getElementById(modalId));
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');
  
    // Set up the click event for the confirm delete button
    confirmDeleteButton.onclick = function() {
      deleteRow(itemId);
      deleteModal.hide();
    };
  
    deleteModal.show();
  }
  
  // Function to delete the row and make an AJAX request to the server
  function deleteRow(itemId) {
    
    console.log(`Deleting item with ID: ${itemId}`);
    
    
    $.ajax({
      url: `/delete_site_allocation_list/${itemId}/`,
      type: 'DELETE',
      headers: {
        'X-CSRFToken': csrftoken, 
      },
      success: function(response) {
        console.log('Item deleted successfully');
        
        $(`[data-item-id=${itemId}]`).remove();
      },
      error: function(xhr, status, error) {
        console.error('Error deleting item:', error);
        alert('Failed to delete item. Please try again.');
      }
    });
  }


</script>

{% endblock header2 %}