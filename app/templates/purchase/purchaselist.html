{% extends "base.html" %}

{% load static %}

{% block header2 %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<!-- Begin page -->
<div id="layout-wrapper">
    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                            <h4 class="mb-sm-0">Purchase Management</h4>

                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboard</a></li>
                                    <li class="breadcrumb-item active">Purchase List</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="row">
                                    <div class="col-xl-6 col-lg-6 col-md-6 col-12">
                                        <h4>Purchase List </h4>
                                    </div>
                                    <div class="col-xl-4 col-lg-4 col-md-4 col-12"></div>
                                    <div class="col-xl-2 col-lg-2 col-md-2 col-12">
                                        <a href="{% url 'purchase' %}" type="button" class="btn btn-info"
                                            style="float:right;">Add Purchase</a>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-xl-3 col-lg-3 col-md-3 col-xs-6 col-12">
                                        <label for="vendor" class="form-label">Vendor Name:</label>
                                        <select class="form-select mb-3" aria-label="Default select example"
                                            id="filterdropdown1" name="vendor">
                                            <option value="0">---------------------</option>
                                            {% for vendor in vendor_names %}
                                            <option value="{{ vendor.id }}">{{ vendor.vendorname }}</option>
                                            {% endfor %}
                                        </select>
                                        <span id="vendorError" class="error-message"></span>
                                    </div>
                                    <div class="col-xl-3 col-lg-3 col-md-3 col-xs-6 col-12">
                                        <label for="exampleInputdate" class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="fromDate">
                                    </div>

                                    <div class="col-xl-3 col-lg-3 col-md-3 col-xs-6 col-12">
                                        <label for="exampleInputdate" class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="toDate">
                                    </div>
                                    <div class="col-xl-3 col-lg-3 col-md-3 col-xs-6 col-12">
                                        <br><button type="button"
                                            class="btn btn-primary waves-effect waves-light mt-2">Get Report</button>
                                    </div>

                                </div>
                                <hr>
                                <table id="example"
                                    class="table table-bordered dt-responsive nowrap table-striped align-middle"
                                    style="width:100%">
                                    <thead>

                                        <tr>
                                            <!-- <th scope="col" style="width: 10px;">
                                                    <div class="form-check">
                                                        <input class="form-check-input fs-15" type="checkbox" id="checkAll" value="option">
                                                    </div>
                                                </th> -->
                                            <th data-ordering="false">S.no</th>
                                            <th data-ordering="false">Date</th>
                                            <th data-ordering="false">Invoice No</th>
                                            <th data-ordering="false">Vendor Name</th>
                                            <th data-ordering="false">Purchase Amount</th>
                                            <th data-ordering="false">paid Amount</th>
                                            <th data-ordering="false">Pending Amount</th>
                                            <th data-ordering="false">Status</th>
                                            <th data-ordering="false" colspan="2">Action</th>
                                           

                                        </tr>
                                    </thead>
                                    <tbody>
                                        
                                    </tbody>


                                </table>

                                <div id="pagination-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->


        </div>
        <!-- end main content-->

    </div>
    <!-- END layout-wrapper -->


    <!-- modal table -->
    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
        id="invoiceHistoryModal" data-bs-keyboard="false" data-bs-backdrop="static" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="myLargeModalLabel">Purchase Items</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>S.no</th>
                                    <th>Item</th>
                                    <th>Qty</th>
                                    <th>Unit</th>
                                    <th>Price</th>
                                    <th>Amount</th>

                                </tr>
                            </thead>
                            <tbody id="modalTableBody">
                                <!-- Modal table body will be populated dynamically -->


                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-link link-success fw-medium shadow-none" data-bs-dismiss="modal"><i
                            class="ri-close-line me-1 align-middle"></i> Close</button>
                    <!-- <button type="button" class="btn btn-primary">Save</button> -->
                </div>
            </div>
        </div>
    </div>


<!-- All Details Modal -->
<div class="modal fade" id="allDetailsModal" tabindex="-1" aria-labelledby="allDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allDetailsModalLabel">Purchase Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Details will be populated here dynamically -->
                <div id="allDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


    <!--start back-to-top-->
    <button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
        <i class="ri-arrow-up-line"></i>
    </button>
    <!--end back-to-top-->

    <!--preloader-->
    <div id="preloader">
        <div id="status">
            <div class="spinner-border text-primary avatar-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>




    <script>

        let activePage;

        // fetch url
        let fetchUrl = "purchase-list"

        // pagination
        const existingPaginationContainer = document.getElementById('pagination-container');

        // table
        const tableBody = document.querySelector('#example tbody');

        // filters 
        const firstDropdown = document.getElementById('filterdropdown1');
        const fromdate = document.getElementById('fromDate');
        const todate = document.getElementById('toDate');

        var currentPage = 1;

        document.addEventListener('DOMContentLoaded', function () {

            // on dom loaded 
            const initialSelectedValue = firstDropdown.value;
            fetchData(1);

            // fetch table data API
            firstDropdown.addEventListener('change', function () {

                activePage = null
                fetchData(currentPage);
            });

            todate.addEventListener('change', function () {
                activePage = null
                fetchData(currentPage);
            });

            fromdate.addEventListener('change', function () {
                activePage = null
                fetchData(currentPage);
            });


        });  


        // fetch data
        function fetchData(page) {

            if (activePage === page) {
                return
            }
            const selectedValue = firstDropdown.value;
            const from = fromdate?.value || ""
            const to = todate?.value || ""
            try {
                fetch(`/${fetchUrl}/${selectedValue}/?page=${page}&start_date=${from}&end_date=${to}`)
                    .then(response => {
                        if (response.status === 200) {
                            console.log('Data fetched');
                            return response.json();
                        } else if (response.status === 404) {
                            throw new Error('Resource not found');
                        } else if (response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        } else {
                            throw new Error('Network response was not ok');
                        }
                    })
                    .then(data => {
                        tableBody.innerHTML = '';
                        renderDataOrMessage(tableBody, data, page)
                        activePage = page
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                    });
            } catch (error) {
                console.error('Error in fetch operation:', error);
            }
        }


        


        // MANIPULATE TABLE DATA
        //  function createTableRow(serialNumber, data) {
          
        //     const newRow = document.createElement('tr');
        //     newRow.setAttribute('data-item-id', data.id);

        //     const idCell = createSerialCell(serialNumber);
        //     newRow.appendChild(idCell);

        //     const td2 = createTableCell(get_value(data.created_at));
        //     newRow.appendChild(td2);

        //     const td3 = createTableCell(get_value(data.invoice_id));
        //     newRow.appendChild(td3);

        //     const td4 = createTableCell(get_value(data.vendor_name));
        //     newRow.appendChild(td4);

        //     const td5 = createAmountCell(get_value(data.total_amount));
        //     newRow.appendChild(td5);

        //     const td6 = createTableCell(get_value(data.paid));
        //     newRow.appendChild(td6);

        //     const td7 = createTableCell(get_value(data.pending));
        //     newRow.appendChild(td7);

            


        //     const td8 = createStatusCell(get_value(data.status_name),data.status_class);
         
        //     newRow.appendChild(td8);

        //     // actioncell
        //     const actionCell = createViewActionCell('invoiceHistoryModal');
        //     newRow.appendChild(actionCell);

        //     // click event
        //     actionCell.addEventListener('click', () => {
        //         populateModalTable(data.get_purchase_items, modalTableBody);
        //     });

            

        //     return newRow;
        // } 


        // MANIPULATE TABLE DATA
        function createTableRow(serialNumber, data) {
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-item-id', data.id);

            const idCell = createSerialCell(serialNumber);
            newRow.appendChild(idCell);

            const td2 = createTableCell(get_value(data.created_at));
            newRow.appendChild(td2);

            const td3 = createTableCell(get_value(data.invoice_id));
            newRow.appendChild(td3);

            const td4 = createTableCell(get_value(data.vendor_name));
            newRow.appendChild(td4);

            const td5 = createAmountCell(get_value(data.total_amount));
            newRow.appendChild(td5);

            const td6 = createTableCell(get_value(data.paid));
            newRow.appendChild(td6);

            const td7 = createTableCell(get_value(data.pending));
            newRow.appendChild(td7);


            const td8 = createStatusCell(get_value(data.status_name),data.status_class);
                
            newRow.appendChild(td8);

            // actioncell
            const actionCell = createViewActionCell('invoiceHistoryModal');
            newRow.appendChild(actionCell);

            actionCell.addEventListener('click', () => {
               populateModalTable(data.get_purchase_items, modalTableBody);
             });



            // Create Edit button
            const editButton = document.createElement('button');
            editButton.innerHTML = '<i class="fas fa-edit"></i>';
            editButton.className = 'btn btn-primary edit-btn';
            editButton.title = 'Edit';
            editButton.addEventListener('click', () => {
                const rowDataId = data.id;
                // Redirect to a new page with the ID
                window.location.href = `/purchase_update/${rowDataId}/`;
            });
            actionCell.appendChild(editButton); 

            return newRow;
        }




        // nested table
        function populateModalTable(items, modalTableBody) {
            modalTableBody.innerHTML = ''; // Clear previous data

            items?.forEach((tItem, index) => {
                const modalRow = document.createElement('tr');

                modalRow.appendChild(createSerialCell(index + 1));
                modalRow.appendChild(createTableCell(tItem.item_name));
                modalRow.appendChild(createTableCell(tItem.qty));
                modalRow.appendChild(createTableCell(tItem.unit_name));
                modalRow.appendChild(createTableCell(tItem.price));
                modalRow.appendChild(createAmountCell(tItem.sub_total));
              
                modalTableBody.appendChild(modalRow);
            });

        }

        //---------------


        //  function createTableRow(serialNumber, data) {
        //     const newRow = document.createElement('tr');
        //     newRow.setAttribute('data-item-id', data.id);
        
        //     const idCell = createSerialCell(serialNumber);
        //     newRow.appendChild(idCell);
        
        //     const td2 = createTableCell(get_value(data.created_at));
        //     newRow.appendChild(td2);
        
        //     const td3 = createTableCell(get_value(data.invoice_id));
        //     newRow.appendChild(td3);
        
        //     const td4 = createTableCell(get_value(data.vendor_name));
        //     newRow.appendChild(td4);
        
        //     const td5 = createAmountCell(get_value(data.total_amount));
        //     newRow.appendChild(td5);
        
        //     const td6 = createTableCell(get_value(data.paid));
        //     newRow.appendChild(td6);
        
        //     const td7 = createTableCell(get_value(data.pending));
        //     newRow.appendChild(td7);
        
        //     // View Action Cell
        //     const actionCell = createViewActionCell('invoiceHistoryModal');
        //     newRow.appendChild(actionCell);
        
        //     // All Details Button
        //     // const detailsCell = document.createElement('td');
        //     // const detailsButton = document.createElement('button');
        //     // detailsButton.className = 'btn btn-secondary';
        //     // detailsButton.textContent = 'All Details';
        //     // detailsButton.addEventListener('click', () => {
        //     //     showAllDetails(data.id);
        //     // });
        //     // detailsCell.appendChild(detailsButton);
        //     // newRow.appendChild(detailsCell);
        
        //     // Click event for View Action Cell
        //     actionCell.addEventListener('click', () => {
        //         populateModalTable(data.get_purchase_items, modalTableBody);
        //     });
        
        //     return newRow;
        // }
        
        // function showAllDetails(purchaseId) {
        //     // Fetch details using the purchaseId
        //     fetch(`/purchase-details/${purchaseId}/`)
        //         .then(response => {
        //             if (response.ok) {
        //                 return response.json();
        //             } else {
        //                 throw new Error('Failed to fetch details');
        //             }
        //         })
        //         .then(data => {
        //             // Populate the modal with the fetched details
        //             const detailsContent = document.getElementById('allDetailsContent');
        //             detailsContent.innerHTML = generateDetailsHTML(data);
        //             // Show the modal
        //             const allDetailsModal = new bootstrap.Modal(document.getElementById('allDetailsModal'));
        //             allDetailsModal.show();
        //         })
        //         .catch(error => {
        //             console.error('Error fetching details:', error);
        //             alert('Error fetching details');
        //         });
        // } 
        


        
        // function updatePurchaseDetails(purchaseId) {
        //     const form = document.getElementById('updateDetailsForm');
        //     const formData = new FormData(form);
        //     const updatedData = {};
            
        //     // Convert FormData to JSON object
        //     formData.forEach((value, key) => {
        //         updatedData[key] = value;
        //     });
        
        //     // Log the updated data for debugging (optional)
        //     console.log('Updated data:', updatedData);
            
        //     fetch(`/purchase-details/${purchaseId}/`, {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //             // Include CSRF token if needed
        //             'X-CSRFToken': getCSRFToken(), // Define getCSRFToken() function as needed
        //         },
        //         body: JSON.stringify(updatedData),
        //     })
        //     .then(response => {
        //         if (response.ok) {
        //             return response.json();
        //         } else {
        //             throw new Error('Failed to update details');
        //         }
        //     })
        //     .then(data => {
        //         console.log('Purchase details updated successfully:', data);
        //         // Optionally update UI or perform other actions
        //     })
        //     .catch(error => {
        //         console.error('Error updating details:', error);
        //         alert('Error updating details');
        //     });
        // }
        

        //   function generateDetailsHTML(data) {
        //     let itemsHTML = data.items.map((item, index) => `
        //         <tr>
        //             <td>${index + 1}</td>
        //             <td><input type="text" class="form-control" value="${item.item_name}" data-index="${index}" data-key="item_name"></td>
        //             <td><input type="text" class="form-control" value="${item.quantity}" data-index="${index}" data-key="quantity"></td>
        //             <td><input type="text" class="form-control" value="${item.unit}" data-index="${index}" data-key="unit"></td>
        //             <td><input type="text" class="form-control" value="${item.amount}" data-index="${index}" data-key="amount"></td>
        //         </tr>
        //     `).join('');
        
        //     return `
        //         <form id="updateDetailsForm">
        //             <div class="mb-3">
        //                 <label for="site" class="form-label"><strong>Site Name:</strong></label>
        //                 <input type="text" class="form-control" id="site" value="${data.site_name}" data-key="site_name">
        //             </div>
        //             <div class="mb-3">
        //                 <label for="invoiceId" class="form-label"><strong>Invoice ID:</strong></label>
        //                 <input type="text" class="form-control" id="invoiceId" value="${data.invoice_id}" data-key="invoice_id">
        //             </div>
        //             <div class="mb-3">
        //                 <label for="companyName" class="form-label"><strong>Company Name:</strong></label>
        //                 <input type="text" class="form-control" id="companyName" value="${data.company_name}" data-key="company_name">
        //             </div>
        //             <div class="mb-3">
        //                 <label for="gst" class="form-label"><strong>GST:</strong></label>
        //                 <input type="text" class="form-control" id="gst" value="${data.gst}" data-key="gst">
        //             </div>
        //             <div class="mb-3">
        //                 <label for="tax" class="form-label"><strong>Tax:</strong></label>
        //                 <input type="text" class="form-control" id="tax" value="${data.tax}" data-key="tax">
        //             </div>
        //             <div class="mb-3">
        //                 <label for="contactNo" class="form-label"><strong>Contact Number:</strong></label>
        //                 <input type="text" class="form-control" id="contactNo" value="${data.contact_no}" data-key="contact_no">
        //             </div>
        //             <div class="mb-3">
        //                 <label for="pendingAmount" class="form-label"><strong>Pending Amount:</strong></label>
        //                 <input type="text" class="form-control" id="pendingAmount" value="${data.pending}" data-key="pending">
        //             </div>
        //             <div class="mb-3">
        //                 <label for="paidAmount" class="form-label"><strong>Paid Amount:</strong></label>
        //                 <input type="text" class="form-control" id="paidAmount" value="${data.paid}" data-key="paid">
        //             </div>
        //             <div class="mb-3">
        //                 <label for="balance" class="form-label"><strong>Balance:</strong></label>
        //                 <input type="text" class="form-control" id="balance" value="${data.balance}" data-key="balance">
        //             </div>
        //             <div class="mb-3">
        //                 <label for="createdAt" class="form-label"><strong>Date:</strong></label>
        //                 <input type="text" class="form-control" id="createdAt" value="${data.created_at}" data-key="created_at">
        //             </div>
        //             <!-- Additional fields can be added here -->
        //             <hr>
        //             <h5>Items</h5>
        //             <table class="table table-bordered">
        //                 <thead>
        //                     <tr>
        //                         <th>S.no</th>
        //                         <th>Item Name</th>
        //                         <th>Quantity</th>
        //                         <th>Unit</th>
        //                         <th>Amount</th>
        //                     </tr>
        //                 </thead>
        //                 <tbody id="itemsTableBody">
        //                     ${itemsHTML}
        //                 </tbody>
        //             </table>
        //             <button type="button" class="btn btn-primary" onclick="updatePurchaseDetails({{ purchase_id }})">Update</button>

        //         </form>
        //     `;
        // }

        
    </script>

    {% endblock header2 %}
