{% extends "base.html" %}
{% load filters %}
{% load static %}


{% block header2 %}

<style>
    .custom-button {
        font-size: 0.85rem;
        /* Increase text size */
        padding: 0.30rem 1.00rem;
        /* Increase button size */
    }

    #create-receipt-btn {
        margin-right: 20px;
        /* Adjust the margin-right as needed */
    }
</style>

<div id="layout-wrapper">

    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                            <h4 class="mb-sm-0"></h4>
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboard</a></li>
                                    <li class="breadcrumb-item active">Project Schedule History</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">


                    <div class="row">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col text-end">
                                        <!-- <a class="btn btn-info btn-sm custom-button mr-3" href="{% url 'project' %}">
                                            Back </a> -->
                                    </div>
                                </div>
                                <!-- <h4>project Schedule History</h4>

                                <div class="row">
                                    <div class="col-md-4 mt-2">
                                        <input type="text" class="form-control" id="" name="client" value="{{project.id}}"  hidden
                                        disabled>
                                        <label for="" class="form-label">Client Name:</label>
                                        <input type="text" class="form-control" name="client" value="{{project.client}}"
                                            disabled>
                                        <span id="clientError" class="error-message"></span>
                                    </div>
                                    <div class="col-md-4 mt-2">
                                        <label for="" class="form-label">Project Name:</label>
                                        <input type="text" class="form-control" name="proj_name"
                                            value="{{ project.proj_name }}" disabled>
                                        <span id="projNameError" class="error-message"></span>
                                    </div>
                                    <div class="col-md-4 mt-2">
                                        <label for="" class="form-label">Site Location:</label>
                                        <input type="text" class="form-control" name="site_location"
                                            value="{{ project.site_location }}" disabled>
                                        <span id="siteLocationError" class="error-message"></span>
                                    </div>
                                    <div class="col-md-4 mt-2">
                                        <label for="" class="form-label">Contact No:</label>
                                        <input type="text" class="form-control" name="contact_no"
                                            value="{{ project.contact_no }}" disabled>
                                        <span id="contactNoError" class="error-message"></span>
                                    </div>
                                    
                                    
                                    <div class="col-md-4 mt-2">
                                        <label for="" class="form-label">Estimation:</label>
                                        <input type="text" class="form-control" name="estimation"
                                            value="{{ project.estimation }}" disabled>
                                        <span id="estimationError" class="error-message"></span>
                                    </div>
                                </div>

                                -->


                                <div class="col-md-12"> <!-- Use most of the space for the table -->
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col">
                                                    <h2>Project History</h2>
                                                </div>

                                                <div class="col text-end p-2">

                                                    <button type="button" class="btn btn-primary btn-sm custom-button"
                                                        data-bs-toggle="modal" data-bs-target=".bs-example-modal-lg">+
                                                        Add
                                                        </button>


                                                </div>



                                            </div>
                                            <div class="row">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <div class="col-xl-2 col-lg-2 col-md-2 col-12">

                                                            <div class="modal fade bs-example-modal-lg p-5"
                                                                tabindex="-1" role="dialog"
                                                                aria-labelledby="myLargeModalLabel" aria-hidden="true">
                                                                
                                                             
                                                                <div class="modal-dialog modal-lg p-5">
                                                                    

                                                                    <div class="modal-content p-4">
                                                                        


                                                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                                                            <h5 class="modal-title">Create New </h5>
                                                                            <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Close" onclick="CloseModel('editModal','{{i.id}}')"></button>
                                                                        </div>
                                                                        
                                                                        <!--  -->


                                                                        <div class="row">

                                                                            <!-- <form id="createForm"> -->
                                                                                <form id="createForm" method="post" action="{% url 'add_project_schedulehistory' pk=project_schedule.id %}" enctype="multipart/form-data">
                                                                                    {% csrf_token %}
                                                                                    <div class="row">
                                                                                        <div class="col-md-6">
                                                                                            <label for="work" class="form-label">Task Name<span style="color: red;">*</span> </label>
                                                                                            <input type="text" class="form-control" id="work" name="work">
                                                                                            <span id="workError" class="error-message"></span>
                                                                                        </div>
                                                                                        <div class="col-md-6">
                                                                                            <label for="qty" class="form-label">Qty<span style="color: red;">*</span> </label>
                                                                                            <input type="text" class="form-control" name="qty" id="qty">
                                                                                            <span id="qtyError" class="error-message"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="row mt-3">  
                                                                                        <div class="col-md-6">
                                                                                            <label for="unit" class="form-label">Unit</label>
                                                                                            <select class="form-select" id="unit" name="unit">
                                                                                                <option value="">----------</option>
                                                                                                {% for uom in unit %}
                                                                                                <option value="{{ uom.id }}">{{ uom.name }}</option>
                                                                                                {% endfor %}
                                                                                            </select>
                                                                                            <span id="unitError" class="error-message"></span>
                                                                                        </div>
                                                                                        <div class="col-md-6">
                                                                                            <label for="date" class="form-label">Date<span style="color: red;">*</span> </label>
                                                                                            <input type="date" class="form-control" name="date" id="date">
                                                                                            <span id="dateError" class="error-message"></span>
                                                                                        </div>
                                                                                        <div class="col-md-6">
                                                                                            <label for="id_img" class="form-label">Image <span style="color: red;">*</span></label>
                                                                                            <input type="file" name="img" class="form-control" id="img">
                                                                                            <span id="imgError" class="error-message "></span>
                                                                                        </div>
                                                                                        <div class="modal-footer">  
                                                                                            <button type="button" class="btn btn-secondary" id="" data-bs-dismiss="modal" onclick="CloseModel('editModal','{{i.id}}')">
                                                                                                Cancel
                                                                                            </button>
                                                                                            <button type="button" class="btn btn-primary" id="saveuom" onclick="createFunction(this, '{{ project_schedule.id }}')">
                                                                                                Save
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                </form>
                                                                            
                                                                           
                                                                            
                                                                        </div>
                                                                    </div>
                                                                    <!-- /.modal-content -->
                                                                </div>
                                                                <!-- /.modal-dialog -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>




                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>S.No</th>
                                                        <th>Date</th>
                                                        <th>Task Name</th>
                                                        <th>Unit</th>
                                                        <th>Qty</th>
                                                        <th>Image</th>
                                                        <!-- <th>End Date</th>  -->
                                                        <th >Action</th>
                                                    </tr>
                                                </thead>
                                               
                                                <tbody>
                                                    {% if project_schedule_history %}
                                                        {% for i in project_schedule_history %}
                                                            <tr>
                                                                <td>{{ forloop.counter }}</td>
                                                                <td>{{ i.date }}</td>
                                                                <td>{{ i.work }}</td>
                                                                <td>{{ i.unit }}</td>
                                                                <td>{{ i.qty }}</td>
                                                                <td>
                                                                    {% if i.img %}
                                                                        <img src="{{ i.img.url }}" alt="{{ i.img.name }}" class="img-responsive" style="height:40px;width:40px;" />
                                                                    {% else %}
                                                                        No Image
                                                                    {% endif %}
                                                                </td>
                                                                <td>



                                                                    <div class="btn-group" role="group">
                                                                        <!-- <button class="btn btn-soft-secondary btn-sm me-2" type="button" data-id="{{i.id}}" onclick="openModal('viewModal', '{{ i.id }}')">
                                                                            <i class="ri-eye-fill align-bottom me-2 text-muted"></i> -->
                                                                            <!-- History
                                                                        </button> -->
    
                                                                        
                                                                        {% comment %} <button class="btn btn-soft-primary btn-sm me-2" type="button" onclick="openModal('editModal','{{ i.id }}')">
                                                                            <!-- <i class="ri-pencil-fill align-bottom me-2 text-muted"></i>  -->
                                                                            Edit
                                                                        </button>
                                                                        <button class="btn btn-soft-danger btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#deleteModal{{ i.id }}">
                                                                            
                                                                            Delete
                                                                        </button>  {% endcomment %}
                                                                        <div class="dropdown">
                                                                          <button class="btn btn-soft-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton{{i.id}}" data-bs-toggle="dropdown" aria-expanded="false">
                                                                              ...
                                                                          </button>
                                                                          <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{i.id}}">
                                                                              <li><a class="dropdown-item" href="#" onclick="openModal('editModal', '{{ i.id }}')"><i
                                                                                class="ri-pencil-fill align-bottom me-2 text-muted"></i>Edit</a></li> 
                                                                              <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#deleteModal{{ i.id }}"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i>Delete</a></li>
                                                                          </ul>
                                                                      </div>
          
          
                                                                        <div class="modal fade" id="editModal_{{ i.id}}" tabindex="-1" aria-labelledby="editModalLabel"
                                    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                                    <div class="modal-dialog modal-lg">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h5 class="modal-title" id="editModalLabel"> Edit Project Schedule '{{i.work}}'
                                           </h5>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                                            onclick="CloseModel('editModal','{{i.id}}')"></button>
                                        </div>
                                        <div class="modal-body">
                                          <form id="editForm{{ i.id }}" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row">
                                              <div class="col-md-6 mb-3">
          
                                              <label for="edit_work" class="form-label">Task Name:</label>
                                              <input type="text" class="form-control" id="{{i.id}}_work" name="work"
                                                value="{{i.work}}" />
          
                                              <span id="{{i.id}}_workError" class="error-message"></span>
                                            </div>
          
                                            <div class="col-md-6 mb-3">
                                              <label for="edit_unit"
                                                  class="form-label">Unit:</label>
                                              <select class="form-select"
                                                  aria-label="Default select example"
                                                  id="{{i.id}}_unit"
                                                  name="unit">
          
                                                  <option value="{{i.unit.id}}"
                                                      selected>{{i.unit.name}}
                                                  </option>
                                                  <option>----------- </option>
                                                  {% for j in unit %}
          
                                                  <option value="{{j.id}}">{{j.name}}
                                                  </option>
                                                  {% endfor %}
                                              </select>
                                              <span id="{{i.id}}_unitError"
                                                  class="error-message"></span>
                                          </div>
                                            
          
                                              <div class="col-md-6 mb-3">
          
                                                  <label for="edit_qty" class="form-label">Quantity:</label>
                                                  <input type="text" class="form-control" id="{{i.id}}_qty" name="qty"
                                                    value="{{i.qty}}" />
              
                                                  <span id="{{i.id}}_qtyError" class="error-message"></span>
                                                </div>
          
                                                <div class="col-md-6 mb-3">
          
                                                  <label for="edit_date"
                                                      class="form-label"> Date:</label>
          
                                                  <input type="date" class="form-control"
                                                      id="{{i.id}}_date"
                                                      name="date"
                                                      value="{{ i.date|date:'Y-m-d' }}" />
          
                                                  <span id="{{i.id}}_dateError"
                                                      class="error-message"></span>
          
                                              </div>

                                              <div class="col-md-6 mb-3">
                                                <label for="edit_img">Image
                                                    :</label>
                                                <input type="file" class="form-control mb-2"
                                                    id="{{i.id}}id_img"
                                                    name="img"
                                                    value="{{ i.img }}">

                                                <span class="file-span">
                                                    <a target="_blank"
                                                        href="{{ i.img }}">
                                                        {{i.img |filename }}
                                                        </a></span>
                                            
                                            </div>
                                            
           
          
                                              
                                              
                                            </div>
                                          </form>
                                        </div>
                                        <div class="modal-footer">
                                          <button type="button" class="btn btn-secondary" id="" data-bs-dismiss="modal"
                                            onclick="CloseModel('editModal','{{i.id}}')">
                                            Cancel
                                          </button>
                                          <button type="button" class="btn btn-primary" id="savecategory"
                                            onclick="updateFunction(this,'{{i.id}}')">
                                            Save
                                          </button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
          
          
                                                                        <div class="modal fade" id="deleteModal{{ i.id}}" tabindex="-1"
                                                                                      aria-labelledby="deleteModalLabel-{{ forloop.counter }}" aria-hidden="true">
                                                                                      <div class="modal-dialog">
                                                                                          <div class="modal-content">
                                                                                          <div class="modal-header">
                                                                                              <h5 class="modal-title" id="deleteModalLabel-{{ forloop.counter }}"> 
                                                                                              {{i.work}}</h5>
                                                                                              <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                                                              aria-label="Close"></button>
                                                                                          </div>
                                                                                          <div class="modal-body">
                                                                                              <p> Are you sure you want to delete "{{ i.work }}"? </p>
                                                                                          </div>
                                                                                          <div class="modal-footer">
                                                                                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Cancel </button>
          
          
                                                                                              <button type="button" onclick="deleteFunction(this,'{{i.id}}')"
                                                                                              class="btn btn-danger">Delete</button>
          
                                                                                          </div>
                                                                                          </div>
                                                                                      </div>
                                                                                      </div>
    </td>
                                                            </tr>
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="6">No project schedule history found.</td>
                                                        </tr>
                                                    {% endif %}
                                                </tbody>
                                                
                                            </table>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

<script>

function createFunction(button, projectScheduleId) {
    var formId = `createForm`;
    var formElement = document.getElementById(formId);
    try {
        disableButton(button);
        var isValid = true;
        var errors = {};
        var formData = new FormData();

        formData.append('date', getValueOrDefault(formElement.querySelector('input[name="date"]').value));
        formData.append('work', getValueOrDefault(formElement.querySelector('input[name="work"]').value));
        formData.append('unit', getValueOrDefault(formElement.querySelector('select[name="unit"]').value));
        formData.append('qty', getValueOrDefault(formElement.querySelector('input[name="qty"]').value));
        var img = document.querySelector('#createForm input[type="file"]').files[0];
        if (img) {
            formData.append("img", img);
        }

        $.ajax({
            url: '/add-project-schedulehistory/' + projectScheduleId + '/',
            type: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function (response, status, xhr) {
                if (xhr.status === 201) {
                    showToast(successMesssage?.message, '', successMesssage?.bgColor, true);
                } else {
                    restoreForm(formId, button);
                }
            },
            error: function (xhr, status, error) {
                if (xhr.status === 400) {
                    if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
                        handleCreateErrors(transformErrors(xhr.responseJSON));
                        restoreForm(formId, button);
                    } else {
                        showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                        restoreForm(formId, button);
                    }
                } else if (xhr.status === 401 || 404) {
                    showToast(xhr?.responseJSON?.details, '', errorAlertMessage?.bgColor);
                    restoreForm(formId, button);
                } else {
                    showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                    restoreForm(formId, button);
                }
            }
        });
    } catch (error) {
        showToast(errorOccured?.message, '', errorOccured?.bgColor);
        restoreForm(formId, button);
        console.error(error);
    }
}


</script>
<script>
    function deleteFunction(button, saveId) {
        try {
          disableButton(button);
    
          $.ajax({
            url: '/delete-project-schedule-history/' + saveId + '/',
            type: 'DELETE',
            headers: {
              'X-CSRFToken': csrftoken,
            },
            processData: false,
            contentType: false,
            success: function (response, status, xhr) {
              if (xhr.status === 204) {
                showToast(deleteMessage?.message, '', deleteMessage?.bgColor, true);
                enableButton(button);
    
              } else {
                showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                enableButton(button);
    
              }
            },
            error: function (xhr, status, error) {
              console.log(xhr, status, error);
              if (xhr.status === 400) {
                if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
                  showToast(xhr?.responseJSON?.details, '', errorAlertMessage?.bgColor);
                  enableButton(button);
                } else {
                  showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                  enableButton(button);
                }
              }
              else if (xhr.status === 401 || 404) {
                showToast(xhr?.responseJSON?.details, '', errorAlertMessage?.bgColor);
                enableButton(button);
              }
              else {
    
                showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                enableButton(button);
              }
            }
          });
        } catch (error) {
          showToast(errorOccured?.message, '', errorOccured?.bgColor);
          console.error(error);
        }
      }
    
    </script>

<script>
    function updateFunction(button, saveId) {

        var formId = `editForm${saveId}`;   //change
        var formElement = document.getElementById(formId);
    
        var isValid = true;
        var errors = {};
    
    
        try {
          disableButton(button);
          clearErrors();
    
          const formData = new FormData();
        formData.append('date', getValueOrDefault(formElement.querySelector('input[name="date"]').value));
        formData.append('work', getValueOrDefault(formElement.querySelector('input[name="work"]').value));
        formData.append('unit', getValueOrDefault(formElement.querySelector('select[name="unit"]').value));
        formData.append('qty', getValueOrDefault(formElement.querySelector('input[name="qty"]').value));
        
        var img = formElement.querySelector('input[name="img"]').files[0];
            if (img) {
                formData.append("img", img);

                
            }
          var requiredKeys = ['work',];     //change
    
          requiredKeys.forEach(function (key) {
            var value = formData.get(key);
            if (!value.trim()) {
              isValid = false;
              errors[key] = ['This field may not be blank.'];
            }
          });
    
          if (!isValid) {
            enableButton(button);
            console.log(errors);
            handleUpdateErrors(saveId, transformErrors(errors));
            return;
          } else {
            $(`#${formId} input, #${formId} button`).prop('disabled', true);
    
          }
    
    
          console.log(csrftoken);
          $.ajax({
            url: '/update-project-schedule-history/' + saveId + '/',   //change
            type: 'PUT',
            headers: {
              'X-CSRFToken': csrftoken,
            },
            processData: false,
            contentType: false,
            data: formData,
            success: function (response, status, xhr) {
              if (xhr.status === 200) {
                showToast(updateMessage?.message, '', updateMessage?.bgColor, true);
                restoreForm(formId, button)
              } else {
                showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                restoreForm(formId, button)
    
              }
            },
            error: function (xhr, status, error) {
              console.log(xhr, status, error);
              if (xhr.status === 400) {
                if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
                  handleUpdateErrors(saveId, transformErrors(xhr.responseJSON));
                  restoreForm(formId, button)
                } else {
    
                  showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                  restoreForm(formId, button)
    
                }
              }
              else if (xhr.status === 401 || 404) {
                showToast(xhr?.responseJSON?.details, '', errorAlertMessage?.bgColor);
                restoreForm(formId, button)
    
              }
              else {
    
                showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
                restoreForm(formId, button)
    
              }
            }
          });
        } catch (error) {
          showToast(errorOccured?.message, '', errorOccured?.bgColor);
          restoreForm(formId, button)
          console.error(error);
        }
      }
    
</script>





{% endblock header2 %}