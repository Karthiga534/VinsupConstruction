{% extends "base.html" %}
{% load filters %}
{% load static %}


{% block header2 %}

<style>
    .custom-button {
        font-size: 0.85rem;
        /* Increase text size */
        padding: 0.30rem 1.00rem;
        /* Increase button size */
    }

    #create-receipt-btn {
        margin-right: 20px;
        /* Adjust the margin-right as needed */
    }
</style>

<div id="layout-wrapper">

    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                            <h4 class="mb-sm-0">Projects</h4>
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboard</a></li>
                                    <li class="breadcrumb-item active">Project Schedule History</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">


                    <div class="row">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col text-end">
                                        <!-- <a class="btn btn-info btn-sm custom-button mr-3" href="{% url 'project' %}">
                                            Back </a> -->
                                    </div>
                                </div>
                                <h4>Payment Process</h4>

                                <div class="row">
                                    <div class="col-md-4 mt-2">
                                        <input type="text" class="form-control" id="" name="client" value="{{project.id}}"  hidden
                                        disabled>
                                        <label for="" class="form-label">Client Name:</label>
                                        <input type="text" class="form-control" name="client" value="{{client_name}}"
                                            disabled>
                                        <span id="clientError" class="error-message"></span>
                                    </div>
                                    <div class="col-md-4 mt-2">
                                        <label for="" class="form-label">Project Name:</label>
                                        <input type="text" class="form-control" name="proj_name"
                                            value="{{ project.proj_name }}" disabled>
                                        <span id="projNameError" class="error-message"></span>
                                    </div>
                                    <div class="col-md-4 mt-2">
                                        <label for="" class="form-label">Site Location:</label>
                                        <input type="text" class="form-control" name="site_location"
                                            value="{{ project.site_location }}" disabled>
                                        <span id="siteLocationError" class="error-message"></span>
                                    </div>
                                    <div class="col-md-4 mt-2">
                                        <label for="" class="form-label">Contact No:</label>
                                        <input type="text" class="form-control" name="contact_no"
                                            value="{{ contact_no }}" disabled>
                                        <span id="contactNoError" class="error-message"></span>
                                    </div>
                                    
                                    
                                    <div class="col-md-4 mt-2">
                                        <label for="" class="form-label">Estimation:</label>
                                        <input type="text" class="form-control" name="estimation"
                                            value="{{ project.estimation }}" disabled>
                                        <span id="estimationError" class="error-message"></span>
                                    </div>
                                </div>

                               


                                <div class="col-md-12"> <!-- Use most of the space for the table -->
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col">
                                                    <h2>Project History</h2>
                                                </div>

                                                <div class="col text-end p-2">

                                                    <button type="button" class="btn btn-primary btn-sm custom-button"
                                                        data-bs-toggle="modal" data-bs-target=".bs-example-modal-lg">+
                                                        Add
                                                        </button>


                                                </div>



                                            </div>
                                            <div class="row">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <div class="col-xl-2 col-lg-2 col-md-2 col-12">

                                                            <div class="modal fade bs-example-modal-lg p-5"
                                                                tabindex="-1" role="dialog"
                                                                aria-labelledby="myLargeModalLabel" aria-hidden="true">
                                                                
                                                             
                                                                <div class="modal-dialog modal-lg p-5">
                                                                    

                                                                    <div class="modal-content p-4">
                                                                        


                                                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                                                            <h5 class="modal-title">Create New </h5>
                                                                            <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Close" onclick="CloseModel('editModal','{{i.id}}')"></button>
                                                                        </div>
                                                                        
                                                                        


                                                                        <div class="row">

                                                                            <!-- <form id="createForm"> -->
                                                                                <form id="createForm" method="post" action="{% url 'add_project_schedulehistory' pk=project.id %}" enctype="multipart/form-data">
                                                                                    
                                                                                    
                                                                                
                                                                                {% csrf_token %}
                                                                                <div class="row">
                                                                                    <div class="col-md-6">
                                                                                        <label for="work" class="form-label">Task Name<span style="color: red;">*</span> </label>
                                                                                        <input type="text" class="form-control" id="work" name="work">
                                                                                        <span id="workError" class="error-message"></span>
                                                                                    </div>
                                                                                    <div class="col-md-6">
                                                                                        <label for="qty" class="form-label">Qty<span style="color: red;">*</span> </label>
                                                                                        <input type="text" class="form-control" name="qty" id="qty">
                                                                                        <span id="qtyError" class="error-message"></span>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="row mt-3">  
                                                                                    <div class="col-md-6">
                                                                                        <label for="unit" class="form-label">Unit</label>
                                                                                        <select class="form-select" id="unit" name="unit">
                                                                                            <option value="">----------</option>
                                                                                            {% for uom in unit %}
                                                                                            <option value="{{ uom.id }}">{{ uom.name }}</option>
                                                                                            {% endfor %}
                                                                                        </select>
                                                                                        <span id="unitError" class="error-message"></span>
                                                                                    </div>
                                                                                    <div class="col-md-6">
                                                                                        <label for="date" class="form-label">Date<span style="color: red;">*</span> </label>
                                                                                        <input type="date" class="form-control" name="date" id="date">
                                                                                        <span id="dateError" class="error-message"></span>
                                                                                    </div>
                                                                                    <div class="col-md-6">
                                                                                        <label for="id_image" class="form-label">Image <span style="color: red;">*</span></label>
                                                                                        <input type="file" name="image" class="form-control"
                                                                                            id="image">
                                                                                        <span id="imageError" class="error-message "></span>
                                                                                    </div>
                                                                                    <div class="modal-footer">
                                                                                        <button class="btn btn-link link-success fw-medium shadow-none" data-bs-dismiss="modal" onclick="clearErrors()">
                                                                                            <i class="ri-close-line me-1 align-middle"></i> Close
                                                                                        </button>
                                                                                        <button type="button" class="btn btn-primary" onclick="createFunction(this, {{ project_schedule.id }})">
                                                                                            Save
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            </form>
                                                                            
                                                                           
                                                                            
                                                                        </div>

                                                                    </div>
                                                                    <!-- /.modal-content -->
                                                                </div>
                                                                <!-- /.modal-dialog -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>




                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>S.No</th>
                                                        <th>Date</th>
                                                        <th>Task Name</th>
                                                        <th>Unit</th>
                                                        <th>Qty</th>
                                                        <th>Image</th>
                                                        <!-- <th>End Date</th>  -->
                                                        <!-- <th >Action</th> -->
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for i in project_schedule_history %}
                                                    <tr>
                                                        <td>{{ forloop.counter }}</td>
                                                        <th>{{i.date}}</th>
                                                        <td>{{ i.work }}</td>
                                                        <td>{{ i.unit }}</td>
                                                        <td>{{ i.qty }}</td>
                                                        <td>
                                                            {% if i.image %}
                                                                <img src="{{ i.image.url }}" alt="{{ i.image.name }}" class="img-responsive"
                                                                style="height:40px;width:40px;" />
                                                            {% else %}
                                                                No Image
                                                            {% endif %}
                                                        </td>
                                                            

                                                    </tr>
                                                    {% endfor %}
                                                </tbody> 
                                                
                                            </table>
                                        </div>
                                    </div>
                                </div>




                            </div>

                        </div>




                    </div>
                </div>
            </div>
        </div>


        



<script>

function createFunction(button) {
				var formId = `createForm`;   //change
				var formElement = document.getElementById(formId); 
				try {
					disableButton(button);
					var isValid = true;
					var errors = {};
					var formData = new FormData();

					var requiredKeys = [];   //change


					              //change
					formData.append('date', getValueOrDefault(formElement.querySelector('input[name="date"]').value));
					formData.append('work', getValueOrDefault(formElement.querySelector('input[name="work"]').value));
					formData.append('unit', getValueOrDefault(formElement.querySelector('select[name="unit"]').value));
					formData.append('qty', getValueOrDefault(formElement.querySelector('input[name="qty"]').value));
                    image = getValueOrDefault(formElement.querySelector('input[name="image"]').value)

                    

					
            var image = document.querySelector('#createForm input[type="file"]').files[0];
            if (image) {
                formData.append("image", image);
            }

					

					requiredKeys.forEach(function (key) {
						var value = formData.get(key);
						if (!value.trim()) {
							isValid = false;
							errors[key] = ['This field may not be blank.'];
						}
					});

					if (!isValid) {
						enableButton(button);
						console_log(errors);
						handleCreateErrors(errors);
						return;
					} else {
						$(`#${formId} input, #${formId} button`).prop('disabled', true);

					}

					$.ajax({
						url: '/add-project-schedulehistory/',                //change
						type: 'POST',
						headers: {
							'X-CSRFToken': csrftoken,
						},
						data: formData,
						processData: false,
						contentType: false,
						success: function (response, status, xhr) {
							console.error(status);
							if (xhr.status === 201) {
								showToast(successMesssage?.message, '', successMesssage?.bgColor, true);
							} else {
								console.error(error);
								restoreForm(formId, button)

							}
						},
						error: function (xhr, status, error) {
							console_log(xhr, status, error);
							if (xhr.status === 400) {
								if (xhr?.responseJSON || xhr?.responseJSON?.errors) {
									handleCreateErrors(transformErrors(xhr.responseJSON));
									restoreForm(formId, button)

								} else {
									showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
									restoreForm(formId, button)

								}
							}
							else if (xhr.status === 401 || 404) {
								showToast(xhr?.responseJSON?.details, '', errorAlertMessage?.bgColor);
								restoreForm(formId, button)

							}
							else {
								showToast(errorAlertMessage?.message, '', errorAlertMessage?.bgColor);
								restoreForm(formId, button)

							}
						}
					});
				} catch (error) {
					showToast(errorOccured?.message, '', errorOccured?.bgColor);
					restoreForm(formId, button)
					console.error(error);
				}
			}




</script> 




{% endblock header2 %}